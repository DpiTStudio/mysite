# Документация приложения Accounts

Приложение `accounts` отвечает за управление пользователями, аутентификацию, регистрацию и профили пользователей на сайте.

## Обзор
Это приложение расширяет стандартную модель пользователя Django, добавляя дополнительные поля (телефон, аватар) и предоставляет функционал для:
- Регистрации пользователей (с капчей)
- Входа в систему (с капчей)
- Выхода из системы
- Просмотра и редактирования личного кабинета

---

## Описание файлов

### 1. `admin.py`
Файл конфигурации административной панели для модели пользователя.

**Классы:**
- `UserAdmin(BaseUserAdmin)`: Наследуется от стандартного `BaseUserAdmin` для настройки отображения пользователей в админке.
    - `list_display`: Определяет поля, видимые в списке пользователей: имя пользователя, email, телефон, имя, фамилия, статус персонала, дата создания.
    - `list_filter`: Добавляет фильтры справа: персонал, суперпользователь, активен, дата создания.
    - `search_fields`: Позволяет искать по имени пользователя, email, телефону, имени и фамилии.
    - `readonly_fields`: Поля только для чтения: дата создания, дата обновления, дата регистрации, последний вход.
    - `fieldsets`: Расширяет стандартные секции формы редактирования, добавляя секцию "Дополнительная информация" с полями `phone` (телефон), `avatar` (аватар), `created_at` (создан), `updated_at` (обновлен).

**Регистрация:**
- `@admin.register(User)`: Декоратор, который регистрирует модель `User` с настройками `UserAdmin` в административной панели.

### 2. `apps.py`
Файл конфигурации приложения.

**Классы:**
- `AccountsConfig(AppConfig)`:
    - `default_auto_field`: Устанавливает тип первичного ключа по умолчанию (`django.db.models.BigAutoField`).
    - `name`: Указывает имя приложения (`accounts`).
    - `verbose_name`: Указывает человекочитаемое имя приложения в админке ("Пользователи").
    - `verbose_name_plural`: Множественное число имени ("Пользователи").

### 3. `forms.py`
Файл содержит Django-формы для обработки пользовательского ввода.

**Импорты:**
- `django.forms`: Базовые классы форм.
- `UserCreationForm`, `AuthenticationForm`: Стандартные формы Django для создания и аутентификации пользователей.
- `CaptchaField`: Поле капчи из библиотеки `captcha`.
- `.models.User`: Кастомная модель пользователя.

**Классы:**

#### `UserRegistrationForm(UserCreationForm)`
Форма регистрации нового пользователя.
- **Поля:**
    - `email`: Обязательное поле Email с виджетом `EmailInput` (CSS класс `form-control`).
    - `phone`: Необязательное поле телефона (макс. 20 символов) с виджетом `TextInput`.
    - `captcha`: Поле для ввода капчи для защиты от ботов. (Требует настройки `django-simple-captcha`).
- **Meta:**
    - `model`: Связана с моделью `User`.
    - `fields`: Включает поля `username`, `email`, `phone`, `password1` (пароль), `password2` (подтверждение).
    - `widgets`: Настройка виджета для `username` с CSS классом `form-control`.
- **Методы:**
    - `__init__`: Расширяет инициализацию родителя, добавляя CSS классы и плейсхолдеры для полей паролей (`password1`, `password2`).

#### `UserLoginForm(AuthenticationForm)`
Форма входа в систему.
- **Поля:**
    - `captcha`: Добавляет обязательное поле капчи при входе.
- **Методы:**
    - `__init__`: Добавляет CSS классы `form-control` и плейсхолдеры для полей `username` и `password` для стилизации Bootstrap.

#### `UserProfileForm(forms.ModelForm)`
Форма редактирования профиля пользователя.
- **Meta:**
    - `model`: Связана с моделью `User`.
    - `fields`: Позволяет редактировать имя, фамилию, email, телефон и аватар.
    - `widgets`: Применяет CSS класс `form-control` ко всем полям для единого стиля.
    - `labels`: Устанавливает понятные подписи к полям на русском языке (Имя, Фамилия, Email и т.д.).

### 4. `models.py`
Файл определения структуры базы данных (моделей).

**Классы:**

#### `User(AbstractUser, TimestampModel)`
Кастомная модель пользователя, наследующая стандартную `AbstractUser` и абстрактную `TimestampModel` (из приложения main).
- **Поля:**
    - Наследует все стандартные поля (username, password, email, first_name, last_name, и т.д.).
    - `phone`: Текстовое поле для телефона (макс. 20 символов), может быть пустым.
    - `avatar`: Поле изображения. Использует утилиту `RenameUploadTo` для сохранения файлов в папку `avatars/` с переименованием. Может быть пустым.
    - *От TimestampModel*: `created_at` (дата создания) и `updated_at` (дата обновления).
- **Meta:**
    - `verbose_name`: "Пользователь".
    - `verbose_name_plural`: "Пользователи".
    - `ordering`: Сортировка по дате создания (новые сверху `-created_at`).
- **Методы:**
    - `__str__`: Возвращает `username` при строковом представлении объекта.

### 5. `urls.py`
Файл маршрутизации URL для приложения.

- `app_name = "accounts"`: Пространство имен для URL (используется как `accounts:view_name`).
- **Маршруты (`urlpatterns`):**
    - `/register/` -> `views.register_view`: Страница регистрации (name="register").
    - `/login/` -> `views.login_view`: Страница входа (name="login").
    - `/logout/` -> `views.logout_view`: Действие выхода (name="logout").
    - `/profile/` -> `views.profile_view`: Страница личного кабинета (name="profile").

### 6. `views.py`
Файл логики представлений (контроллеров).

**Функции:**

#### `register_view(request)`
Обрабатывает регистрацию пользователей.
1. Проверяет, аутентифицирован ли пользователь. Если да — перенаправляет в профиль.
2. **POST запрос**:
    - Создает экземпляр `UserRegistrationForm` с данными запроса.
    - Проверяет валидность формы `form.is_valid()`.
    - Если валидна: сохраняет пользователя, сразу авторизует его (`login`), выводит сообщение успеха (`messages.success`) и перенаправляет в профиль.
3. **GET запрос**: Создает пустую форму.
4. Рендерит шаблон `accounts/register.html` с формой.

#### `login_view(request)`
Обрабатывает вход пользователей.
1. Проверяет аутентификацию (если уже вошел — редирект в профиль).
2. **POST запрос**:
    - Создает `UserLoginForm` с данными.
    - Если валидна: получает пользователя через `form.get_user()`, авторизует (`login`), выводит приветствие.
    - Обрабатывает параметр `next` из URL для перенаправления пользователя обратно на страницу, с которой он пришел (с проверкой безопасности, что это внутренний URL).
3. **GET запрос**: Создает пустую форму.
4. Рендерит шаблон `accounts/login.html`.

#### `logout_view(request)`
Обрабатывает выход.
- Декоратор `@login_required`: Только для авторизованных.
- Вызывает `logout(request)` для очистки сессии.
- Выводит сообщение и перенаправляет на главную (`main:home`).

#### `profile_view(request)`
Отображает и обновляет профиль пользователя.
- Декоратор `@login_required`.
- **POST запрос**:
    - Создает `UserProfileForm` с данными POST и FILES (для загрузки аватара), привязанную к текущему пользователю (`instance=request.user`).
    - Если валидна: сохраняет изменения, выводит сообщение об успехе, перенаправляет на эту же страницу (PRG pattern).
- **GET запрос**: Создает форму, предзаполненную текущими данными пользователя.
- Рендерит шаблон `accounts/profile.html`.
