"""
Модуль views.py приложения accounts

Этот файл содержит представления (views) для обработки HTTP-запросов,
связанных с аутентификацией и управлением профилем пользователя.

Представления обрабатывают:
- Регистрацию новых пользователей
- Вход в систему (авторизацию)
- Выход из системы
- Просмотр и редактирование профиля пользователя
"""

# Импорт функций для работы с шаблонами и перенаправлениями
from django.shortcuts import render, redirect
# Импорт функций для работы с аутентификацией пользователей
from django.contrib.auth import login, logout
# Импорт декоратора для ограничения доступа только авторизованным пользователям
from django.contrib.auth.decorators import login_required
# Импорт системы сообщений Django для вывода уведомлений пользователю
from django.contrib import messages
# Импорт форм приложения для обработки пользовательского ввода
from .forms import UserRegistrationForm, UserLoginForm, UserProfileForm


def register_view(request):
    """
    Представление для регистрации нового пользователя.
    
    Обрабатывает GET и POST запросы на странице регистрации.
    При успешной регистрации автоматически авторизует пользователя и перенаправляет в профиль.
    
    Логика работы:
    1. Проверяет, не авторизован ли уже пользователь (если да - перенаправляет в профиль)
    2. При POST запросе:
       - Создает форму с данными из запроса
       - Валидирует форму (проверяет корректность данных, уникальность username, совпадение паролей)
       - Если форма валидна: сохраняет пользователя в БД, авторизует его, выводит сообщение об успехе
       - Перенаправляет в личный кабинет
    3. При GET запросе: отображает пустую форму регистрации
    
    Args:
        request: HTTP-запрос от клиента (объект HttpRequest)
    
    Returns:
        HttpResponse: HTML-страница с формой регистрации или редирект в профиль
    """
    # Проверка: если пользователь уже авторизован, перенаправляем его в профиль
    # Это предотвращает повторную регистрацию уже авторизованных пользователей
    if request.user.is_authenticated:
        return redirect("accounts:profile")
    
    # Обработка POST запроса (отправка формы регистрации)
    if request.method == "POST":
        # Создание экземпляра формы с данными из POST запроса
        form = UserRegistrationForm(request.POST)
        
        # Валидация формы
        # is_valid() проверяет:
        # - Корректность всех полей (email формат, длина username и т.д.)
        # - Уникальность username и email
        # - Совпадение паролей (password1 и password2)
        # - Правильность ввода капчи
        if form.is_valid():
            # Сохранение нового пользователя в базу данных
            # form.save() создает объект User и сохраняет его через ORM Django
            user = form.save()
            
            # Автоматическая авторизация пользователя после регистрации
            # login() создает сессию для пользователя, чтобы он был авторизован сразу
            login(request, user)
            
            # Вывод сообщения об успешной регистрации
            # Сообщение будет отображено на следующей странице через систему messages Django
            messages.success(request, "Регистрация прошла успешно!")
            
            # Перенаправление в личный кабинет после успешной регистрации
            return redirect("accounts:profile")
    else:
        # GET запрос: создание пустой формы для отображения на странице
        form = UserRegistrationForm()
    
    # Рендеринг шаблона с формой регистрации
    # Шаблон находится в templates/accounts/register.html
    return render(request, "accounts/register.html", {"form": form})


def login_view(request):
    """
    Представление для входа (авторизации) пользователя в систему.
    
    Обрабатывает GET и POST запросы на странице входа.
    Поддерживает параметр 'next' для перенаправления пользователя на страницу,
    с которой он пришел (например, если пытался зайти на защищенную страницу).
    
    Логика работы:
    1. Проверяет, не авторизован ли уже пользователь
    2. При POST запросе:
       - Создает форму с данными из запроса
       - Валидирует форму (проверяет username/password и капчу)
       - Если валидна: получает пользователя, авторизует его, выводит приветствие
       - Обрабатывает параметр 'next' для редиректа на нужную страницу
    3. При GET запросе: отображает пустую форму входа
    
    Args:
        request: HTTP-запрос от клиента
    
    Returns:
        HttpResponse: HTML-страница с формой входа или редирект
    """
    # Проверка: если пользователь уже авторизован, перенаправляем в профиль
    if request.user.is_authenticated:
        return redirect("accounts:profile")
    
    # Обработка POST запроса (отправка формы входа)
    if request.method == "POST":
        # Создание формы с данными из POST запроса
        # data=request.POST указывает, что это данные для аутентификации
        form = UserLoginForm(data=request.POST)
        
        # Валидация формы
        # is_valid() проверяет:
        # - Существование пользователя с таким username
        # - Правильность пароля
        # - Правильность ввода капчи
        if form.is_valid():
            # Получение объекта пользователя из формы
            # get_user() возвращает объект User, соответствующий введенным данным
            user = form.get_user()
            
            # Авторизация пользователя (создание сессии)
            login(request, user)
            
            # Вывод приветственного сообщения с именем пользователя
            messages.success(request, f"Добро пожаловать, {user.username}!")
            
            # Получение URL для перенаправления после входа
            # Параметр 'next' обычно передается, когда пользователь пытался зайти на защищенную страницу
            # Если параметра нет, используем профиль по умолчанию
            next_url = request.GET.get("next", "accounts:profile")
            
            # Обработка случая, когда next_url - это имя маршрута (например, "accounts:profile")
            # а не полный URL (например, "/accounts/profile/")
            # Если это имя маршрута, преобразуем его в URL через reverse()
            if next_url and not next_url.startswith("/"):
                from django.urls import reverse
                try:
                    # Преобразование имени маршрута в полный URL
                    next_url = reverse(next_url)
                except:
                    # Если маршрут не найден, используем профиль по умолчанию
                    next_url = "accounts:profile"
            
            # Перенаправление на нужную страницу
            return redirect(next_url)
    else:
        # GET запрос: создание пустой формы для отображения
        form = UserLoginForm()
    
    # Рендеринг шаблона с формой входа
    return render(request, "accounts/login.html", {"form": form})


@login_required
def logout_view(request):
    """
    Представление для выхода пользователя из системы.
    
    Доступно только авторизованным пользователям (декоратор @login_required).
    Очищает сессию пользователя и перенаправляет на главную страницу.
    
    Args:
        request: HTTP-запрос от клиента
    
    Returns:
        HttpResponse: Редирект на главную страницу с сообщением об успешном выходе
    """
    # Выход пользователя из системы
    # logout() удаляет данные пользователя из сессии, делая его неавторизованным
    logout(request)
    
    # Вывод сообщения об успешном выходе
    messages.success(request, "Вы успешно вышли из системы.")
    
    # Перенаправление на главную страницу сайта
    return redirect("main:home")


@login_required
def profile_view(request):
    """
    Представление личного кабинета пользователя.
    
    Позволяет просматривать и редактировать данные профиля:
    - Имя и фамилия
    - Email
    - Телефон
    - Аватар (загрузка изображения)
    
    Доступно только авторизованным пользователям.
    
    Логика работы:
    1. При POST запросе:
       - Создает форму с данными из POST и FILES (для загрузки аватара)
       - Привязывает форму к текущему пользователю (instance=request.user)
       - Валидирует и сохраняет изменения
       - Выводит сообщение об успехе и перенаправляет на эту же страницу (PRG pattern)
    2. При GET запросе:
       - Создает форму, предзаполненную текущими данными пользователя
       - Отображает страницу профиля
    
    Args:
        request: HTTP-запрос от клиента
    
    Returns:
        HttpResponse: HTML-страница с формой редактирования профиля
    """
    # Обработка POST запроса (отправка формы редактирования)
    if request.method == "POST":
        # Создание формы с данными из POST запроса и файлами из FILES
        # request.POST содержит текстовые данные формы
        # request.FILES содержит загруженные файлы (например, аватар)
        # instance=request.user привязывает форму к текущему пользователю
        #   Это означает, что форма будет обновлять существующего пользователя, а не создавать нового
        form = UserProfileForm(request.POST, request.FILES, instance=request.user)
        
        # Валидация формы
        if form.is_valid():
            # Сохранение изменений в базе данных
            # form.save() обновляет объект request.user с новыми данными
            form.save()
            
            # Вывод сообщения об успешном обновлении профиля
            messages.success(request, "Профиль успешно обновлен!")
            
            # Перенаправление на эту же страницу (PRG pattern - Post-Redirect-Get)
            # Это предотвращает повторную отправку формы при обновлении страницы
            return redirect("accounts:profile")
    else:
        # GET запрос: создание формы, предзаполненной текущими данными пользователя
        # instance=request.user автоматически заполняет поля формы данными из БД
        form = UserProfileForm(instance=request.user)
    
    # Рендеринг шаблона с формой профиля
    return render(request, "accounts/profile.html", {"form": form})
