# Приложение Logfiles - Управление файлами логов

## Описание

Приложение `logfiles` предназначено для управления и мониторинга файлов логов в системе Django. Оно позволяет администраторам просматривать, анализировать, создавать резервные копии и управлять лог-файлами через админ-панель Django.

## Основные возможности

- Автоматическая синхронизация лог-файлов из директории `logs/`
- Просмотр содержимого лог-файлов с предпросмотром последних строк
- Создание резервных копий лог-файлов
- Очистка содержимого лог-файлов с автоматическим созданием резервной копии
- Отображение размера файлов в удобочитаемом формате (Б, КБ, МБ, ГБ)
- Отслеживание даты последнего изменения файлов
- Связь между лог-файлами и их резервными копиями

---

## Структура файлов

### `models.py` - Модели данных

#### Класс `LogFile`

Модель для представления файла лога в базе данных.

**Поля модели:**

- `name` (CharField, max_length=255) - Название файла лога
- `file_path` (CharField, max_length=500) - Полный путь к файлу лога в файловой системе
- `size` (BigIntegerField) - Размер файла в байтах
- `last_modified` (DateTimeField, auto_now=True) - Дата и время последнего изменения файла (обновляется автоматически)
- `created_at` (DateTimeField, auto_now_add=True) - Дата и время создания записи в базе данных

**Методы:**

- `__str__()` - Возвращает название файла для отображения в админке
- `get_file_size_display()` - Конвертирует размер из байт в читаемый формат (Б, КБ, МБ, ГБ, ТБ)
- `update_file_info()` - Обновляет информацию о файле (размер и дату изменения) на основе фактического состояния файла в файловой системе

**Meta-опции:**

- `verbose_name` = "Файл лога"
- `verbose_name_plural` = "Файлы логов"
- `ordering` = ["-last_modified"] - Сортировка по дате последнего изменения (новые сверху)

#### Класс `LogBackup`

Модель для хранения информации о резервных копиях логов.

**Поля модели:**

- `log_file` (ForeignKey) - Связь с оригинальным файлом лога (удаление каскадное)
- `backup_file` (FileField) - Файл резервной копии, сохраняется в `media/logs/backups/`
- `backup_size` (BigIntegerField) - Размер резервной копии в байтах
- `created_at` (DateTimeField, auto_now_add=True) - Дата создания резервной копии
- `description` (TextField, optional) - Дополнительное описание резервной копии

**Методы:**

- `__str__()` - Возвращает строку вида "Копия [название файла] от [дата создания]"
- `get_backup_size_display()` - Возвращает размер копии в читаемом формате

**Meta-опции:**

- `verbose_name` = "Резервная копия лога"
- `verbose_name_plural` = "Резервные копии логов"
- `ordering` = ["-created_at"] - Сортировка по дате создания (новые сверху)

---

### `admin.py` - Административный интерфейс

#### Класс `LogFileAdmin`

Административный класс для управления файлами логов через админ-панель Django.

**Основные возможности:**

1. **Автоматическая синхронизация** - При открытии списка файлов логов автоматически выполняется синхронизация с директорией `logs/`
2. **Отображение информации** - Показывает название, путь, размер, дату изменения и количество резервных копий
3. **Действия над файлами** - Создание резервной копии, очистка, обновление информации

**Методы класса:**

- `changelist_view()` - Переопределяет стандартный вид списка, автоматически синхронизирует логи при открытии страницы
  - Сканирует директорию `logs/` на наличие файлов `.log`
  - Создает записи для новых файлов или обновляет информацию о существующих

- `file_path_display()` - Отображает путь к файлу в моноширинном шрифте
- `size_display()` - Отображает размер файла в читаемом формате
- `backups_count()` - Показывает количество резервных копий с ссылкой на их список
- `actions_column()` - Отображает кнопки действий:
  - "Создать копию" - создает резервную копию файла
  - "Очистить" - очищает содержимое файла (с предварительным созданием копии)
  - "Обновить" - обновляет информацию о файле

- `file_content_preview()` - Показывает последние 50 строк содержимого файла в формате `<pre>` с прокруткой
  - Если файл не найден, показывает сообщение об ошибке
  - Обрабатывает ошибки чтения файла

- `get_urls()` - Добавляет кастомные URL-маршруты для действий:
  - `/create_backup/` - создание резервной копии
  - `/clear_log/` - очистка файла
  - `/refresh/` - обновление информации

- `create_backup()` - Создает резервную копию лог-файла
  - Проверяет существование файла
  - Создает директорию для резервных копий при необходимости
  - Генерирует имя файла с временной меткой (формат: `[название]_YYYYMMDD_HHMMSS.log`)
  - Копирует файл с сохранением метаданных
  - Создает запись в базе данных
  - Показывает сообщение об успехе/ошибке

- `clear_log()` - Очищает содержимое лог-файла
  - При GET-запросе показывает страницу подтверждения
  - При POST-запросе:
    - Создает автоматическую резервную копию перед очисткой
    - Очищает содержимое файла (записывает пустую строку)
    - Обновляет информацию о файле
    - Создает запись о резервной копии

- `refresh_log()` - Обновляет информацию о файле (размер, дата изменения)

- `has_add_permission()` - Запрещает ручное добавление файлов логов (только автоматическая синхронизация)

- `has_delete_permission()` - Запрещает удаление файлов логов через админку

#### Класс `LogBackupAdmin`

Административный класс для управления резервными копиями.

**Методы:**

- `backup_size_display()` - Отображает размер копии в читаемом формате
- `download_link()` - Создает ссылку для скачивания резервной копии
- `has_add_permission()` - Запрещает ручное добавление резервных копий

**Настройки отображения:**

- `list_display` - Список файла, файл копии, размер, дата создания, ссылка для скачивания
- `list_filter` - Фильтрация по дате создания и связанному лог-файлу
- `search_fields` - Поиск по названию файла и описанию
- `date_hierarchy` - Иерархический фильтр по дате
- `readonly_fields` - Все поля кроме описания доступны только для чтения

---

### `views.py` - Представления

Файл пустой - вся функциональность реализована через административный интерфейс.

---

### `apps.py` - Конфигурация приложения

Стандартная конфигурация Django приложения без дополнительных настроек.

---

### `urls.py`

Приложение не использует собственные URL-маршруты, так как вся функциональность доступна через админ-панель Django по адресу `/admin/logfiles/`.

Кастомные действия доступны через URL, создаваемые в методе `get_urls()` класса `LogFileAdmin`.

---

## Использование

### Доступ к функциональности

1. Войдите в админ-панель Django как администратор
2. Перейдите в раздел "Logfiles" → "Файлы логов"
3. Система автоматически синхронизирует файлы из директории `logs/`

### Работа с лог-файлами

**Просмотр списка файлов:**
- Откройте "Файлы логов" в админке
- Вы увидите список всех `.log` файлов из директории `logs/`
- Для каждого файла отображается:
  - Название
  - Путь к файлу
  - Размер
  - Дата последнего изменения
  - Количество резервных копий
  - Кнопки действий

**Просмотр содержимого:**
- Откройте конкретный файл лога
- В разделе "Содержимое файла" вы увидите последние 50 строк

**Создание резервной копии:**
- Нажмите кнопку "Создать копию" в списке файлов
- Резервная копия будет сохранена в `media/logs/backups/`
- Имя файла будет содержать временную метку

**Очистка файла:**
- Нажмите кнопку "Очистить" в списке файлов
- Подтвердите действие
- Система автоматически создаст резервную копию перед очисткой
- Содержимое файла будет удалено

**Обновление информации:**
- Нажмите кнопку "Обновить" для обновления размера и даты изменения файла

### Работа с резервными копиями

1. Перейдите в "Logfiles" → "Резервные копии логов"
2. Вы увидите список всех созданных копий
3. Можете фильтровать по дате создания или связанному файлу
4. Используйте ссылку "Скачать копию" для загрузки файла

---

## Настройка

### Расположение лог-файлов

По умолчанию приложение ищет файлы логов в директории `logs/` относительно `BASE_DIR` (корня проекта).

Это настроено в методе `changelist_view()`:

```python
log_dir = Path(settings.BASE_DIR) / "logs"
```

### Расположение резервных копий

Резервные копии сохраняются в `media/logs/backups/` относительно `MEDIA_ROOT`.

---

## Зависимости

- Django
- Стандартная библиотека Python: `os`, `shutil`, `pathlib`

---

## Безопасность

- Все действия доступны только администраторам (через админ-панель Django)
- Запрещено удаление файлов логов через админку
- Запрещено ручное добавление файлов (только автоматическая синхронизация)
- При очистке файла автоматически создается резервная копия

---

## Обработка ошибок

- Если файл не найден при выполнении действий, показывается сообщение об ошибке
- Ошибки синхронизации при открытии списка игнорируются (не прерывают работу)
- Ошибки чтения файла для предпросмотра обрабатываются и показываются пользователю

---

## Будущие улучшения

Возможные дополнения:
- Автоматическая ротация логов
- Фильтрация и поиск по содержимому файлов
- Экспорт логов в различные форматы
- Настройка размера предпросмотра
- Email-уведомления при превышении размера файлов
