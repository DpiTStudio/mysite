# Документация приложения Logfiles

Приложение `logfiles` предназначено для управления серверными логами через административную панель Django. Оно позволяет просматривать, очищать и создавать резервные копии лог-файлов, хранящихся на сервере.

## Обзор
Приложение автоматически сканирует директорию логов, регистрирует файлы в базе данных и предоставляет интерфейс для:
- Просмотра списка логов с их размером и датой изменения.
- Предпросмотра последних строк лог-файла прямо в админке.
- Создания резервных копий логов.
- Очистки содержимого логов (с автоматическим созданием бэкапа перед очисткой).
- Скачивания резервных копий.

---

## Описание файлов

### 1. `admin.py`
Центральный файл логики приложения. Содержит настройку административного интерфейса и реализацию действий над файлами.

**Классы:**

#### `LogFileAdmin(admin.ModelAdmin)`
Админка для управления файлами логов.
- **Отображение (`list_display`):** Имя, путь, размер, дата изменения, кол-во копий, кнопки действий.
- **Логика синхронизации (`changelist_view`):** При открытии списка логов автоматически сканирует папку `logs` в корне проекта и регистрирует/обновляет файлы в БД.
- **Действия (Колонки/Кнопки):**
    - `backups_count`: Ссылка на список резервных копий для данного файла.
    - `actions_column`: Генерирует HTML-кнопки "Создать копию", "Очистить", "Обновить".
    - `file_content_preview`: Читает последние 50 строк файла и выводит их в блоке `<pre>` для предпросмотра.
- **Custom Views (Кастомные действия):**
    - `create_backup(request, logfile_id)`:
        1. Проверяет существование файла.
        2. Копирует файл в папку бэкапов с временной меткой.
        3. Создает запись `LogBackup` в БД.
        4. Выводит сообщение об успехе.
    - `clear_log(request, logfile_id)`:
        1. Если POST запрос: Создает принудительную резервную копию ("before_clear").
        2. Полностью очищает содержимое файла (перезаписывает пустой строкой).
        3. Обновляет информацию о размере.
    - `refresh_log(request, logfile_id)`: Принудительно обновляет данные о размере и дате изменения файла из файловой системы.
- **Права доступа:** Запрещает ручное добавление/удаление записей логов (`has_add_permission`, `has_delete_permission` = False).

#### `LogBackupAdmin(admin.ModelAdmin)`
Админка для управления резервными копиями.
- **Отображение:** Файл лога, файл бэкапа, размер, дата создания, ссылка на скачивание.
- **Поля:** `download_link` генерирует HTML-ссылку для скачивания файла.
- **Права:** Запрещено ручное создание бэкапов через форму (только через действия в `LogFileAdmin`).

### 2. `apps.py`
Конфигурация приложения.
- `verbose_name = 'Управление логами'`: Имя в админке.

### 3. `models.py`
Модели данных для хранения мета-информации о файлах.

**Классы:**

#### `LogFile(models.Model)`
Хранит информацию о физическом файле лога.
- **Поля:**
    - `name`: Имя файла.
    - `file_path`: Абсолютный путь к файлу.
    - `size`: Размер в байтах.
    - `last_modified`: Время последнего изменения.
- **Методы:**
    - `get_file_size_display()`: Конвертирует байты в КБ, МБ, ГБ.
    - `update_file_info()`: Низкоуровневая функция. Проверяет `os.stat` файла на диске и обновляет поля `size` и `last_modified` в БД.

#### `LogBackup(models.Model)`
Хранит историю резервных копий.
- **Поля:**
    - `log_file`: Ссылка на исходный `LogFile`.
    - `backup_file`: Путь к файлу копии (через `FileField`).
    - `backup_size`: Размер копии.
    - `description`: Описание (например, "Автоматическая копия перед очисткой").
- **Методы:**
    - `get_backup_size_display()`: Аналогично модели лога, форматирует размер.

### 4. `views.py`
Пустой файл, так как вся логика взаимодействия реализована через административную панель (`admin.py`).
