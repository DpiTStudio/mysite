# Приложение Mail - Управление электронной почтой

## Описание

Приложение `mail` предоставляет функциональность для управления электронной почтой в системе Django. Оно позволяет администраторам просматривать входящие письма через IMAP и отправлять тестовые письма через SMTP.

## Основные возможности

- Просмотр последних 10 входящих писем из папки INBOX
- Отправка тестовых писем для проверки настроек SMTP
- Отображение информации о настройках почтового сервера
- Декодирование заголовков писем (тема, отправитель)
- Автоматическое определение кодировки текста

---

## Структура файлов

### `models.py` - Модели данных

Файл содержит только комментарий о том, что здесь можно будет хранить настройки или логи почты при необходимости. В текущей версии модели не используются.

---

### `views.py` - Представления (Views)

#### Функция `is_staff(user)`

Вспомогательная функция для проверки прав доступа.

**Параметры:**
- `user` - Объект пользователя Django

**Возвращает:**
- `True` если пользователь является сотрудником (staff), иначе `False`

**Использование:**
Используется в декораторе `@user_passes_test` для ограничения доступа к функциям представления только сотрудникам.

---

#### Функция `mail_index(request)`

Отображает список последних 10 сообщений из папки INBOX.

**Декоратор:**
- `@user_passes_test(is_staff)` - Доступ только для сотрудников

**Функциональность:**

1. **Подключение к IMAP-серверу:**
   - Использует настройки из `settings.IMAP_HOST` и `settings.IMAP_PORT`
   - Устанавливает SSL-соединение через `imaplib.IMAP4_SSL`
   - Выполняет аутентификацию с учетными данными из `settings.IMAP_USER` и `settings.IMAP_PASSWORD`
   - Выбирает папку "inbox" для работы

2. **Получение списка писем:**
   - Выполняет поиск всех сообщений (`mail.search(None, "ALL")`)
   - Берет последние 10 идентификаторов сообщений
   - Разворачивает список (самые новые первыми)

3. **Обработка каждого письма:**
   - Загружает полное сообщение через `mail.fetch(msg_id, "(RFC822)")`
   - Парсит письмо через `email.message_from_bytes()`
   - Декодирует тему письма с учетом кодировки
   - Декодирует информацию об отправителе
   - Извлекает дату письма

4. **Формирование данных:**
   Создает список словарей с информацией о каждом письме:
   - `id` - Идентификатор сообщения
   - `subject` - Тема письма (декодированная)
   - `from` - Отправитель (декодированный)
   - `date` - Дата письма

5. **Обработка ошибок:**
   - При возникновении ошибки сохраняет текст ошибки в переменную `error`
   - Выполняет безопасный выход из IMAP-сессии

6. **Рендеринг шаблона:**
   Передает в контекст шаблона:
   - `emails` - Список писем
   - `error` - Текст ошибки (если была)
   - `imap_host` - Адрес IMAP-сервера
   - `smtp_host` - Адрес SMTP-сервера
   - `user_email` - Email пользователя

**Возвращает:**
- HTTP-ответ с отрендеренным шаблоном `mail/index.html`

---

#### Функция `send_test_email(request)`

Отправляет тестовое письмо для проверки настроек SMTP.

**Декоратор:**
- `@user_passes_test(is_staff)` - Доступ только для сотрудников

**Функциональность:**

1. **Обработка POST-запроса:**
   - Получает адрес получателя из `request.POST.get("recipient")`
   - Проверяет, что адрес указан

2. **Отправка письма:**
   - Использует `django.core.mail.send_mail()` для отправки
   - Тема письма: "Тестовое письмо от DPIT-CMS"
   - Текст письма: "Это тестовое письмо, подтверждающее правильность настроек SMTP."
   - Отправитель: `settings.DEFAULT_FROM_EMAIL`
   - Получатель: Адрес из формы
   - `fail_silently=False` - Вызывает исключение при ошибке отправки

3. **Обработка результатов:**
   - При успехе: Показывает сообщение об успешной отправке
   - При ошибке: Показывает сообщение с описанием ошибки
   - Если адрес не указан: Показывает предупреждение

4. **Перенаправление:**
   - После обработки перенаправляет на главную страницу почты (`mail:index`)

**Возвращает:**
- HTTP-редирект на `mail:index`

---

### `urls.py` - URL-маршруты

Определяет URL-паттерны для приложения mail.

**Пространство имен:** `mail`

**Маршруты:**

1. `""` (пустой путь)
   - View: `views.mail_index`
   - Name: `index`
   - URL: `/mail/`

2. `"send-test/"`
   - View: `views.send_test_email`
   - Name: `send_test`
   - URL: `/mail/send-test/`

**Использование в шаблонах:**
```django
{% url 'mail:index' %}
{% url 'mail:send_test' %}
```

---

### `admin.py` - Административный интерфейс

Файл содержит только стандартный импорт без регистрации моделей, так как приложение не использует модели.

---

### `apps.py` - Конфигурация приложения

Стандартная конфигурация Django приложения без дополнительных настроек.

---

### `models.py` - Модели

В текущей версии не содержит активных моделей. Зарезервировано для будущего использования.

---

## Настройка

### Требуемые настройки в `settings.py`

Приложение использует следующие настройки из Django settings:

**IMAP настройки:**
```python
IMAP_HOST = "imap.timeweb.ru"  # Адрес IMAP-сервера
IMAP_PORT = 993  # Порт IMAP (SSL)
IMAP_USER = "admin@dpit-cms.ru"  # Имя пользователя IMAP
IMAP_PASSWORD = "password"  # Пароль IMAP
```

**SMTP настройки (стандартные Django):**
```python
EMAIL_HOST = "smtp.timeweb.ru"  # Адрес SMTP-сервера
EMAIL_PORT = 465  # Порт SMTP (SSL)
EMAIL_USE_SSL = True  # Использовать SSL
EMAIL_HOST_USER = "admin@dpit-cms.ru"  # Имя пользователя SMTP
EMAIL_HOST_PASSWORD = "password"  # Пароль SMTP
DEFAULT_FROM_EMAIL = EMAIL_HOST_USER  # Email отправителя по умолчанию
```

---

## Использование

### Доступ к функциональности

1. Войдите в систему как сотрудник (staff)
2. Перейдите по адресу `/mail/`
3. Вы увидите список последних 10 входящих писем

### Просмотр входящих писем

На странице `/mail/` отображается:
- Список последних 10 писем из папки INBOX
- Для каждого письма: тема, отправитель, дата
- Информация о настройках почтового сервера
- Форма для отправки тестового письма

### Отправка тестового письма

1. На странице `/mail/` введите адрес получателя в форму
2. Нажмите кнопку отправки
3. Вы получите сообщение об успехе или ошибке

---

## Зависимости

- Django
- Стандартная библиотека Python:
  - `imaplib` - Для работы с IMAP
  - `email` - Для парсинга писем
  - `email.header.decode_header` - Для декодирования заголовков

---

## Безопасность

- Доступ к функциональности ограничен только сотрудниками (staff)
- Используется SSL для соединения с почтовыми серверами
- Рекомендуется хранить пароли в переменных окружения, а не в коде

---

## Обработка ошибок

- Ошибки подключения к IMAP обрабатываются и отображаются пользователю
- Ошибки отправки письма показываются через систему сообщений Django
- Декодирование заголовков использует обработку ошибок (`errors="replace"`)

---

## Будущие улучшения

Возможные дополнения:
- Просмотр полного содержимого писем
- Отправка ответов на письма
- Фильтрация и поиск по письмам
- Работа с несколькими папками (не только INBOX)
- Сохранение писем в базе данных
- Архивация старых писем
- Поддержка вложений

---

## Особенности реализации

### Декодирование заголовков

Приложение использует функцию `decode_header()` из модуля `email.header` для правильного декодирования заголовков писем, которые могут быть в различных кодировках (UTF-8, Windows-1251, и т.д.).

### SSL-соединение

Используется `IMAP4_SSL` для безопасного подключения к IMAP-серверу через порт 993.

### Ограничение доступа

Все функции представления защищены декоратором `@user_passes_test(is_staff)`, который проверяет, что пользователь имеет статус сотрудника перед доступом к функциональности.
