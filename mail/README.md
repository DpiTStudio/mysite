# Документация приложения Mail

Приложение `mail` предназначено для проверки и использования почтового функционала сайта. Оно позволяет просматривать последние входящие письма (через IMAP) и отправлять тестовые письма (через SMTP) администраторам сайта.

## Обзор
Приложение не имеет собственных моделей базы данных. Оно работает напрямую с почтовыми протоколами, используя настройки из `settings.py`. Доступ к функционалу ограничен правами персонала (`staff`).

---

## Описание файлов

### 1. `apps.py`
Файл конфигурации приложения.
- `name = 'mail'`: Имя приложения.
- `verbose_name = 'Управление почтой'`: Имя в админке (хотя модели не зарегистрированы, это используется Django для метаданных).

### 2. `urls.py`
Файл маршрутизации.
- `app_name = "mail"`: Пространство имен URLs.
- **Маршруты:**
    - `""` (пустой путь) -> `views.mail_index`: Главная страница почтового интерфейса (name="index").
    - `send-test/` -> `views.send_test_email`: Обработчик отправки тестового письма (name="send_test").

### 3. `views.py`
Основная логика работы с почтой.

**Вспомогательные функции:**
- `is_staff(user)`: Проверяет, является ли пользователь персоналом сайта (`user.is_staff`). Используется в декораторах.

**Функции представлений:**

#### `mail_index(request)`
Отображает последние входящие письма. Доступно только персоналу (`@user_passes_test(is_staff)`).
1. **Подключение к IMAP:**
   - Использует настройки `settings.IMAP_HOST`, `settings.IMAP_PORT`, `settings.IMAP_USER`, `settings.IMAP_PASSWORD`.
   - Подключается по SSL и выбирает папку `inbox`.
2. **Получение писем:**
   - Ищет все письма (`mail.search(None, "ALL")`).
   - Получает последние 10 ID сообщений.
   - Перебирает эти ID и загружает заголовки (`mail.fetch(msg_id, "(RFC822)")`).
3. **Обработка данных:**
   - Использует библиотеку `email` для парсинга тела ответа.
   - Декодирует тему (`Subject`) и отправителя (`From`) с учетом кодировок (UTF-8 и др.).
   - Формирует список словарей `emails` с полями `id`, `subject`, `from`, `date`.
4. **Контекст и рендер:**
   - Передает в шаблон список писем, настройки хостов (для отображения статуса) и возможные ошибки.
   - Рендерит шаблон `mail/index.html`.

#### `send_test_email(request)`
Обрабатывает отправку тестового письма. Доступно только персоналу.
1. Ожидает `POST` запрос.
2. Получает email получателя из `request.POST.get("recipient")`.
3. **Отправка:**
   - Использует функцию Django `send_mail`.
   - Тема: "Тестовое письмо от DPIT-CMS".
   - Тело: Статический текст.
   - Отправитель: `settings.DEFAULT_FROM_EMAIL`.
   - Получатель: Список из одного адресата.
4. **Результат:**
   - В случае успеха: сообщение `messages.success`.
   - В случае ошибки: сообщение `messages.error` с текстом исключения.
5. Перенаправляет обратно на индексную страницу `mail:index`.

### 4. `models.py` и `admin.py`
Файлы пусты (содержат только комментарии или базовые импорты), так как приложение не хранит данные в базе данных, а работает как утилита реального времени.
