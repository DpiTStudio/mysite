# Документация приложения Main

Приложение `main` является ядром проекта `dpit-cms`. Оно отвечает за глобальные настройки сайта, статические страницы, главную страницу, обработку ошибок, а также предоставляет базовые абстрактные модели и утилиты, используемые в других приложениях.

## Обзор
Это приложение связывает воедино остальные компоненты системы. Здесь определяются:
- Глобальные настройки сайта (название, логотип, контакты).
- Статические страницы (О нас, Контакты, Правила).
- Базовые шаблоны и контекстные процессоры для шапки и футера.
- Утилиты для работы с файлами и строками.
- Карта сайта (Sitemap) и robots.txt.

---

## Описание файлов

### 1. `admin.py`
Настройка административной панели.

**Классы:**

#### `LogEntryAdmin(admin.ModelAdmin)`
Позволяет просматривать журнал действий администраторов (кто, что и когда изменил).
- **Отображение:** Время, пользователь, тип контента, объект, действие (Добавление/Изменение/Удаление).
- **Права:** Только чтение (удаление и изменение записей журнала запрещено).

#### `SiteSettingsAdmin(admin.ModelAdmin)`
Управление глобальными настройками.
- **Особенности:**
    - Имитирует режим "Синглтона" (одна запись настроек), запрещая добавление или удаление записей, если одна уже существует (реализовано через `has_add_permission` и `has_delete_permission`).
    - **Поля:**
        - Основные: Название, слоган, домен.
        - SEO: Мета-теги.
        - Контент: Логотип, фавикон, фон шапки по умолчанию.
        - Контакты: Адрес, телефоны, email.

#### `PageAdmin(admin.ModelAdmin)`
Управление статическими страницами.
- **Отображение:** Заголовок, слаг, активность, порядок, превью логотипа.
- **Поля:**
    - `prepopulated_fields`: Автоматическое заполнение `slug` из `title`.
    - `fieldsets`: Группировка полей (Основное, Медиа, Меню, SEO).

### 2. `context_processors.py`
Файл с контекстными процессорами, добавляющими данные во все шаблоны.

#### `main_context(request)`
Основная функция, формирующая контекст для рендеринга `base.html`.
- **Возвращает:**
    - `site_settings`: Объект настроек сайта.
    - `menu_pages`: Список активных страниц для меню.
    - `header_data`: Словарь с данными для динамической шапки (заголовок, описание, фоновое изображение).
- **Логика определения шапки:**
    Анализирует URL (`request.path`) и определяет, в каком разделе находится пользователь:
    1. **Новости**: Ищет категорию или конкретную новость, берет заголовки и фон оттуда.
    2. **Портфолио**: Аналогично новостям.
    3. **Отзывы/Тикеты**: Устанавливает статические заголовки.
    4. **Статические страницы**: Берет данные из модели `Page`.
    5. **По умолчанию**: Берет данные из `SiteSettings`.

### 3. `forms.py`
Формы приложения.

#### `ContactForm(forms.Form)`
Форма обратной связи.
- **Поля:** Имя, Email, Телефон, Сообщение.
- **Особенности:** Включает поле `captcha` для защиты от спама. Использует стили Bootstrap (`form-control`).

### 4. `models.py`
Модели данных и абстрактные классы.

**Абстрактные модели (используются другими приложениями):**
- `ActiveModel`: Добавляет поле `is_active` (активность).
- `TimestampModel`: Добавляет поля `created_at` (дата создания) и `updated_at` (дата обновления).
- `SEOModel`: Добавляет поля `meta_title`, `meta_keywords`, `meta_description`.
- `HeaderModel`: Добавляет поля для кастомизации шапки (`header_image`, `header_title`, `header_description`).

**Основные модели:**

#### `SiteSettings(ActiveModel, SEOModel)`
Хранит настройки всего сайта.
- Поля: Название, телефоны, email, логотипы, фоны, адрес, время работы.
- Доступна только одна запись.

#### `Page(ActiveModel, TimestampModel, SEOModel)`
Динамические страницы контента.
- Поля:
    - `content`: HTML-контент (через TinyMCE).
    - `show_in_menu`: Флаг отображения в навигации.
    - `slug`: URL страницы.
    - `logo`, `fon_headers`: Индивидуальное оформление.

### 5. `sitemaps.py`
Генерация XML-карты сайта для поисковиков.
- Классы `Sitemap` для: Страниц, Новостей, Категорий новостей, Портфолио, Категорий портфолио, Статических View (Главная, Списки).

### 6. `utils.py`
Вспомогательные утилиты.

#### `transliterate(string)`
Функция для превращения кириллицы в латиницу (транслитерация). Используется при генерации имен файлов.

#### `RenameUploadTo`
Класс-декоратор для полей загрузки файлов (`upload_to`).
- **Логика:**
    1. Получает имя файла и расширение.
    2. Ищет значимый атрибут в объекте (title, name, username) для формирования имени.
    3. Транслитерирует имя и превращает в slug.
    4. Добавляет текущую дату и время.
    5. **Итог**: Файлы сохраняются как `papka/nazvanie_2023-01-01_12-00-00.jpg`, что предотвращает дубликаты и проблемы с кодировкой.

### 7. `views.py`
Представления (Views).

#### `home(request)`
Главная страница.
- **Логика:**
    - Если пользователь — персонал (`is_staff`), собирает расширенную статистику (кол-во новостей, портфолио, отзывов, тикетов, просмотров) для отображения дашборда.
    - Рендерит `main/home.html`.

#### `page_detail(request, slug)`
Отображение статической страницы.
- **Логика:**
    - Ищет страницу по слагу.
    - Если слаг `kontakty`: обрабатывает форму `ContactForm`. При успешной отправке шлет email админу через `send_mail`.
    - Рендерит `main/page_detail.html`.

#### `robots_txt(request)`
Генерирует файл `robots.txt` динамически, подставляя текущий протокол и хост.

### 8. `urls.py`
Маршруты приложения.
- `/` -> `home`: Главная.
- `/page/<slug>/` -> `page_detail`: Статические страницы.
