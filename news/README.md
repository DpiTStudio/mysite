# Приложение News - Система новостей

## Описание

Приложение `news` реализует полнофункциональную систему новостей с поддержкой категорий, событий дня, комментариев и автоматическим созданием новостей на основе действий в системе. Новости могут быть привязаны к конкретной дате и содержать несколько событий за день.

## Основные возможности

- Управление категориями новостей с SEO-настройками
- Создание новостей с HTML-контентом
- Система событий дня - автоматическое создание новостей при изменениях в других приложениях
- Комментарии и рейтинги к новостям
- RSS-лента последних новостей
- Поиск по новостям
- Фильтрация по категориям
- Пагинация списка новостей
- Счетчик просмотров
- Контекстный процессор для отображения последних новостей на всех страницах

---

## Структура файлов

### `models.py` - Модели данных

#### Класс `NewsCategory`

Модель категории новостей. Наследуется от абстрактных моделей `ActiveModel`, `SEOModel`, `HeaderModel` из приложения `main`.

**Поля модели:**

- `name` (CharField, max_length=100) - Название категории
- `slug` (SlugField, unique=True) - URL-адрес категории (уникальный)
- `logo` (ImageField) - Логотип категории, загружается в `media/news/categories/`
- `description` (TextField) - Описание категории
- `content` (HTMLField) - HTML-описание категории на странице (по умолчанию: `<p>Описание</p>`)
- `order` (IntegerField, default=0) - Порядок сортировки категорий

**Наследуемые поля от абстрактных моделей:**

От `ActiveModel`:
- `is_active` (BooleanField) - Активна ли категория

От `SEOModel`:
- `meta_title` - SEO заголовок
- `meta_keywords` - SEO ключевые слова
- `meta_description` - SEO описание

От `HeaderModel`:
- `header_image` - Изображение для шапки страницы категории
- `header_title` - Заголовок шапки
- `header_description` - Описание в шапке

**Методы:**

- `__str__()` - Возвращает название категории

**Meta-опции:**

- `verbose_name` = "Категория новостей"
- `verbose_name_plural` = "Категории новостей"
- `ordering` = ["order", "name"] - Сортировка сначала по порядку, затем по названию

---

#### Класс `News`

Модель новости. Представляет дневную сводку новостей - одна запись содержит все события за один день.

**Поля модели:**

- `title` (CharField, max_length=200) - Заголовок новости
- `slug` (SlugField, unique=True) - URL-адрес новости (уникальный)
- `category` (ForeignKey) - Связь с категорией новостей (каскадное удаление)
- `news_date` (DateField, default=timezone.now) - Дата новости (год, месяц, день)
- `image` (ImageField, optional) - Изображение новости, загружается в `media/news/images/`
- `content` (HTMLField, default="<p>Контент сайта</p>") - HTML-содержимое новости
- `views` (IntegerField, default=0) - Счетчик просмотров

**Наследуемые поля:**

От `ActiveModel`:
- `is_active` - Активна ли новость

От `SEOModel`:
- `meta_title`, `meta_keywords`, `meta_description` - SEO поля

От `TimestampModel`:
- `created_at` - Дата создания записи
- `updated_at` - Дата последнего обновления

**Методы:**

- `__str__()` - Возвращает строку вида "Заголовок (дата)"
- `increment_views()` - Увеличивает счетчик просмотров на 1
  - Использует `update()` для оптимизации (избегает вызова `save()` и сигналов)
- `get_events_count()` - Возвращает количество событий, привязанных к новости

**Meta-опции:**

- `verbose_name` = "Новость"
- `verbose_name_plural` = "Новости"
- `ordering` = ["-news_date", "-created_at"] - Сортировка по дате новости (новые сверху)
- `unique_together` = [['category', 'news_date']] - Уникальность: одна новость на дату в рамках категории

**Особенности:**
Модель разработана для группировки событий по дням. При создании или изменении объектов в других приложениях (портфолио, отзывы, страницы, услуги) автоматически создаются или обновляются новости для соответствующей даты.

---

#### Класс `DailyEvent`

Модель отдельного события в рамках дневной новости. Несколько событий могут быть привязаны к одной новости (одному дню).

**Поля модели:**

- `news` (ForeignKey, related_name="events") - Связь с новостью дня (каскадное удаление)
- `event_type` (CharField, max_length=50) - Тип события
  - Выборы:
    - `'portfolio_added'` - Добавлена работа в портфолио
    - `'portfolio_updated'` - Обновлена работа в портфолио
    - `'review_approved'` - Одобрен отзыв
    - `'page_created'` - Создана страница
    - `'page_updated'` - Обновлена страница
    - `'service_added'` - Добавлена услуга
    - `'service_updated'` - Обновлена услуга
    - `'service_order_new'` - Новый заказ услуги
    - `'other'` - Другое событие
- `title` (CharField, max_length=300) - Заголовок события
- `description` (HTMLField) - Описание события (HTML)
- `related_object_id` (IntegerField, optional) - ID связанного объекта
- `related_object_type` (CharField, max_length=50, optional) - Тип связанного объекта (название класса модели)
- `image` (ImageField, optional) - Изображение события, загружается в `media/news/events/`
- `order` (IntegerField, default=0) - Порядок отображения события

**Наследуемые поля:**

От `TimestampModel`:
- `created_at` - Время создания события
- `updated_at` - Время обновления события

**Методы:**

- `__str__()` - Возвращает строку вида "Заголовок (время создания)"

**Meta-опции:**

- `verbose_name` = "Событие дня"
- `verbose_name_plural` = "События дня"
- `ordering` = ['order', '-created_at'] - Сортировка по порядку и времени создания

---

#### Класс `Comment`

Модель комментария к новости.

**Поля модели:**

- `news` (ForeignKey, related_name="comments") - Связь с новостью (каскадное удаление)
- `rating` (IntegerField, default=0) - Рейтинг/оценка новости
- `text` (TextField) - Текст комментария

**Наследуемые поля:**

От `TimestampModel`:
- `created_at` - Дата создания комментария
- `updated_at` - Дата обновления комментария

**Методы:**

- `__str__()` - Возвращает строку вида "Комментарий к [заголовок новости]"

**Meta-опции:**

- `verbose_name` = "Комментарий"
- `verbose_name_plural` = "Комментарии"
- `ordering` = ["-created_at"] - Сортировка по дате (новые сверху)

---

### `views.py` - Представления (Views)

#### Функция `get_latest_news()`

Вспомогательная функция для получения последних 3 активных новостей с использованием кеширования.

**Функциональность:**

1. Использует кеш Django для оптимизации
2. Ключ кеша: `"latest_news"`
3. Если данных нет в кеше:
   - Выбирает последние 3 активные новости
   - Использует `select_related("category")` для оптимизации запросов
   - Сортирует по дате создания (новые первыми)
4. Кеширует результат на 5 минут (300 секунд)

**Возвращает:**
- Список из 3 объектов `News`

**Использование:**
Используется в представлениях для отображения последних новостей в боковой панели или на главной странице.

---

#### Функция `news_list(request)`

Отображает список всех новостей с пагинацией.

**Функциональность:**

1. Получает queryset активных новостей:
   - Фильтрует только активные новости (`is_active=True`)
   - Использует `select_related("category")` для оптимизации
   - Сортирует по дате создания (новые первыми)

2. Получает список категорий:
   - Фильтрует активные категории
   - Добавляет аннотацию `news_count` с количеством новостей в каждой категории

3. Пагинация:
   - По 9 новостей на страницу
   - Обрабатывает параметр `page` из GET-запроса
   - Обрабатывает исключения (неверный номер страницы, пустая страница)

4. Рендеринг шаблона:
   - Передает объект страницы с новостями
   - Список категорий
   - Последние 3 новости (через функцию `get_latest_news()`)

**Шаблон:** `news/list.html`

**URL:** `/news/`

---

#### Функция `news_by_category(request, category_slug)`

Отображает новости по конкретной категории с пагинацией.

**Параметры:**

- `category_slug` - URL-слаг категории из URL-маршрута

**Функциональность:**

1. Получает категорию по слагу:
   - Использует `get_object_or_404()` для безопасного получения
   - Проверяет, что категория активна

2. Фильтрует новости:
   - Только из указанной категории
   - Только активные новости

3. Получает список всех категорий (для бокового меню)

4. Применяет пагинацию (9 новостей на страницу)

5. Рендеринг:
   - Передает отфильтрованные новости
   - Текущую категорию
   - Список всех категорий
   - Последние новости

**Шаблон:** `news/list.html`

**URL:** `/news/category/<category_slug>/`

---

#### Функция `news_search(request)`

Реализует поиск новостей по запросу.

**Функциональность:**

1. Получает поисковый запрос из GET-параметра `q`
2. Очищает запрос от пробелов
3. Если запрос не пустой:
   - Ищет по заголовку (`title__icontains`)
   - Ищет по SEO описанию (`meta_description__icontains`)
   - Ищет по содержимому (`content__icontains`)
   - Использует оператор `Q` с `|` (ИЛИ) для объединения условий
   - Регистронезависимый поиск (`icontains`)
4. Если запрос пустой, возвращает пустой queryset
5. Применяет пагинацию (9 новостей на страницу)
6. Рендеринг:
   - Передает результаты поиска
   - Поисковый запрос
   - Список категорий
   - Последние новости

**Шаблон:** `news/list.html`

**URL:** `/news/search/?q=запрос`

---

#### Функция `news_detail(request, slug)`

Отображает детальную страницу новости.

**Параметры:**

- `slug` - URL-слаг новости

**Функциональность:**

1. Получает новость по слагу:
   - Использует `annotate()` для добавления агрегированных данных:
     - `total_comments` - Общее количество комментариев
     - `avg_rating` - Средний рейтинг из комментариев
   - Фильтрует только активные новости
   - Обрабатывает исключение `DoesNotExist` с логированием и 404 ошибкой

2. Увеличивает счетчик просмотров:
   - Вызывает `news.increment_views()`
   - Логирует просмотр

3. Подготовка контекста:
   - Объект новости
   - Количество комментариев (или 0, если нет)
   - Средний рейтинг (или 0, если нет)

4. Рендеринг шаблона `news/detail.html`

**Шаблон:** `news/detail.html`

**URL:** `/news/<slug>/`

**Особенности:**
- Использует оптимизированный метод `increment_views()` для обновления счетчика
- Логирует просмотры для аналитики

---

### `admin.py` - Административный интерфейс

#### Класс `DailyEventInline`

Inline-админка для отображения событий дня непосредственно в форме редактирования новости.

**Настройки:**

- `model` = `DailyEvent`
- `extra` = 0 - Не показывать пустые формы для новых событий
- `fields` - Отображаемые поля
- `readonly_fields` - Только чтение для `created_at`
- `ordering` - Сортировка по порядку и дате создания

---

#### Класс `NewsCategoryAdmin`

Административный класс для управления категориями новостей.

**Настройки отображения:**

- `form` = `NewsCategoryForm` - Использует кастомную форму с TinyMCE
- `list_display` - Колонки в списке: название, активность, порядок
- `list_editable` - Редактируемые прямо в списке: порядок, активность
- `prepopulated_fields` - Автозаполнение slug из названия
- `list_filter` - Фильтр по активности
- `search_fields` - Поиск по названию

**Fieldsets (группы полей):**

1. **Основная информация:**
   - Название, slug, логотип, описание, контент, порядок, активность

2. **Настройка шапки (Header):**
   - Изображение, заголовок, описание шапки для страницы категории

3. **SEO настройки:**
   - Мета-заголовок, ключевые слова (сворачиваемый раздел)

---

#### Класс `NewsAdmin`

Административный класс для управления новостями.

**Настройки:**

- `form` = `NewsForm` - Кастомная форма с TinyMCE
- `inlines` = `[DailyEventInline]` - Встроенное отображение событий дня
- `list_display` - Колонки: заголовок, категория, дата новости, количество событий, активность, дата создания, просмотры
- `list_editable` - Редактируемая колонка: активность
- `prepopulated_fields` - Автозаполнение slug
- `list_filter` - Фильтры: категория, активность, дата новости, дата создания
- `search_fields` - Поиск: заголовок, содержимое
- `date_hierarchy` = "news_date" - Иерархический фильтр по дате новости

**Методы:**

- `events_count(obj)` - Отображает количество событий в новости с цветным форматированием

**Fieldsets:**

1. **Основная информация:**
   - Заголовок, slug, категория, дата новости, изображение, содержимое, просмотры

2. **SEO настройки:**
   - Мета-заголовок, ключевые слова, мета-описание (сворачиваемый)

3. **Дополнительно:**
   - Активность (сворачиваемый)

---

#### Класс `DailyEventAdmin`

Административный класс для управления событиями дня.

**Настройки:**

- `list_display` - Заголовок, новость, тип события, порядок, дата создания
- `list_filter` - Фильтры: тип события, категория новости, дата создания
- `search_fields` - Поиск: заголовок, описание, заголовок новости
- `readonly_fields` - Только чтение: дата создания и обновления
- `date_hierarchy` = "created_at" - Иерархический фильтр по дате

**Fieldsets:**

1. **Основная информация:**
   - Новость, тип события, заголовок, описание, изображение, порядок

2. **Связанный объект:**
   - Тип объекта, ID объекта (сворачиваемый)

3. **Временные метки:**
   - Дата создания, дата обновления (сворачиваемый)

---

### `signals.py` - Django Signals (Сигналы)

Файл содержит сигналы для автоматического создания новостей и событий при изменениях в других приложениях.

#### Функция `transliterate(string)`

Транслитерирует кириллицу в латиницу для создания slug.

**Параметры:**
- `string` - Строка с кириллическими символами

**Возвращает:**
- Строку с транслитерированными символами

**Функциональность:**
- Заменяет заглавные русские буквы на латинские
- Заменяет строчные русские буквы на латинские
- Использует словари для замены

---

#### Функция `get_unique_slug(model_class, title)`

Генерирует уникальный slug для модели.

**Параметры:**
- `model_class` - Класс модели Django
- `title` - Заголовок для генерации slug

**Возвращает:**
- Уникальный slug (строка)

**Алгоритм:**
1. Транслитерирует заголовок
2. Преобразует в slug через `slugify()`
3. Если slug пустой, использует "news-item"
4. Проверяет уникальность, добавляя суффикс `-1`, `-2` и т.д. при необходимости

---

#### Функция `get_or_create_daily_news(category, event_date)`

Получает или создает новость для указанной даты и категории.

**Параметры:**
- `category` - Объект `NewsCategory`
- `event_date` - Объект `date` (дата события)

**Возвращает:**
- Объект `News`

**Алгоритм:**
1. Ищет существующую новость для этой даты и категории
2. Если найдена - возвращает её
3. Если не найдена:
   - Создает заголовок в формате "События [дата] - [категория]"
   - Генерирует уникальный slug
   - Создает новую новость с базовым контентом
   - Логирует создание

---

#### Функция `add_event_to_daily_news(news, event_type, title, description, related_obj=None, image=None)`

Добавляет событие к дневной новости.

**Параметры:**
- `news` - Объект `News`
- `event_type` - Тип события (строка)
- `title` - Заголовок события
- `description` - Описание события (HTML)
- `related_obj` - Связанный объект (опционально)
- `image` - Изображение события (опционально)

**Возвращает:**
- Объект `DailyEvent`

**Алгоритм:**
1. Проверяет, не добавлено ли уже это событие (защита от дублей)
2. Определяет порядок события (количество существующих событий)
3. Формирует данные для создания события:
   - Базовые поля
   - Если есть связанный объект - сохраняет его ID и тип
   - Если есть изображение - сохраняет его
4. Создает событие
5. Обновляет контент новости (вызывает `update_news_content()`)
6. Логирует создание события

---

#### Функция `update_news_content(news)`

Обновляет HTML-контент новости на основе всех её событий.

**Параметры:**
- `news` - Объект `News`

**Алгоритм:**
1. Получает все события новости, отсортированные по порядку
2. Формирует новый контент:
   - Заголовок с датой
   - Количество событий
   - Для каждого события:
     - Заголовок с номером
     - Время создания
     - Описание события
     - Разделитель
3. Обновляет поле `content` новости
4. Сохраняет только поле `content` (оптимизация через `update_fields`)

---

#### Сигнал `@receiver(post_save)`

Автоматически создает события в дневных новостях при сохранении объектов других моделей.

**Обрабатываемые модели:**

1. **Portfolio (Портфолио):**
   - При создании: `portfolio_added`
   - При обновлении: `portfolio_updated`
   - Создает категорию новостей на основе категории портфолио

2. **Review (Отзыв):**
   - При одобрении (`status == 'approved'`): `review_approved`
   - Создает категорию "Отзывы"

3. **Page (Страница):**
   - При создании: `page_created`
   - При обновлении: `page_updated`
   - Создает категорию "Страницы"

4. **Service (Услуга):**
   - При создании: `service_added`
   - При обновлении: `service_updated`
   - Включает информацию о цене в описание события
   - Создает категорию "Услуги"

5. **ServiceOrder (Заказ услуги):**
   - При создании с статусом 'new': событие типа `other`
   - Включает информацию о клиенте и услуге
   - Создает категорию "Заказы услуг"

**Особенности:**
- Избегает рекурсии (игнорирует сохранение самих моделей News, NewsCategory, DailyEvent)
- Использует текущую дату для группировки событий
- Автоматически создает категории новостей при необходимости
- Логирует ошибки при создании событий

---

### `forms.py` - Формы

#### Класс `NewsCategoryForm`

Форма для редактирования категории новостей.

**Особенности:**
- Использует TinyMCE виджет для поля `description`
- Все поля модели включены автоматически

---

#### Класс `NewsForm`

Форма для редактирования новости.

**Особенности:**
- Использует TinyMCE виджет для полей `content` и `meta_description`
- Все поля модели включены автоматически

---

### `urls.py` - URL-маршруты

**Пространство имен:** `news`

**Маршруты:**

1. `""` - Список новостей (`views.news_list`)
2. `"search/"` - Поиск новостей (`views.news_search`)
3. `"category/<category_slug>/"` - Новости по категории (`views.news_by_category`)
4. `"feed/"` - RSS-лента (`LatestNewsFeed`)
5. `"<slug>/"` - Детальная страница новости (`views.news_detail`)

---

### `feeds.py` - RSS-лента

#### Класс `LatestNewsFeed`

RSS-лента для последних новостей.

**Настройки:**

- `title` = "Последние новости"
- `link` = "/news/"
- `description` = "Последние новости сайта"

**Методы:**

- `items()` - Возвращает последние 20 активных новостей
- `item_title(item)` - Заголовок элемента
- `item_description(item)` - Описание (SEO описание новости)
- `item_pubdate(item)` - Дата публикации (`created_at`)
- `item_link(item)` - Ссылка на новость (абсолютный URL)

**URL:** `/news/feed/`

---

### `context_processors.py` - Контекстные процессоры

#### Функция `latest_news(request)`

Контекстный процессор, добавляющий последние новости и категории во все шаблоны.

**Возвращает словарь:**

- `latest_news` - Последние 3 активные новости
- `categories` - До 10 активных категорий с количеством новостей в каждой

**Использование:**
Добавлен в `settings.py` в `TEMPLATES['OPTIONS']['context_processors']`, поэтому доступен во всех шаблонах автоматически.

---

## Использование

### Просмотр новостей

1. Список всех новостей: `/news/`
2. Новости по категории: `/news/category/<category_slug>/`
3. Поиск: `/news/search/?q=запрос`
4. Детальная страница: `/news/<slug>/`
5. RSS-лента: `/news/feed/`

### Администрирование

1. Войдите в админ-панель Django
2. Перейдите в раздел "News"
3. Управляйте категориями, новостями и событиями дня

### Автоматическое создание новостей

Система автоматически создает новости при:
- Добавлении/обновлении работ в портфолио
- Одобрении отзывов
- Создании/обновлении страниц
- Добавлении/обновлении услуг
- Создании новых заказов услуг

Все события группируются по датам - за один день создается одна новость с несколькими событиями.

---

## Зависимости

- Django
- django-tinymce (для HTML-редактора)
- Приложение `main` (абстрактные модели: ActiveModel, SEOModel, HeaderModel, TimestampModel)

---

## Кеширование

Последние новости кешируются на 5 минут для оптимизации производительности.

---

## Особенности

- Новости привязаны к конкретной дате (одна новость = один день)
- Несколько событий могут быть в одной новости
- Автоматическое обновление контента новости при добавлении событий
- Защита от дублей событий
- Оптимизированное увеличение счетчика просмотров

---

## SEO

- Поддержка SEO полей (title, keywords, description)
- Уникальные slug для каждой новости и категории
- RSS-лента для индексации поисковыми системами
