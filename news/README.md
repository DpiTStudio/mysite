# Документация приложения News

Приложение `news` отвечает за публикацию новостей, статей и автоматическую генерацию событий на сайте.

## Обзор
Это приложение позволяет создавать новости вручную через админку, а также имеет мощную систему **сигналов**, которая автоматически генерирует новостные поводы при добавлении работ в портфолио, публикации отзывов или создании новых страниц. 

**⭐ НОВОЕ:** Реализована система группировки событий по датам! Теперь все события одного дня автоматически объединяются в одну дневную новость. Подробнее см. [README_DAILY_NEWS.md](./README_DAILY_NEWS.md)

Поддерживает RSS-ленты, поиск и категоризацию.

---

## Описание файлов

### 1. `admin.py`
Настройка административной панели.

**Классы:**
- `NewsCategoryAdmin`: Управление категориями.
    - Особенности: Настройка SEO, изменение шапки (Header) для категории, сортировка.
- `NewsAdmin`: Управление новостями.
    - Особенности: Фильтрация по дате новости (`news_date`) и категории, поиск по контенту, группировка полей (SEO, Дополнительно).
    - **НОВОЕ:** Inline-редактор событий дня (`DailyEventInline`), отображение количества событий.
- `DailyEventAdmin`: Управление отдельными событиями дня.
    - Фильтрация по типу события, категории, дате создания.

### 2. `apps.py`
Конфигурация приложения.
- `ready()`: Метод переопределен для импорта модуля `news.signals`. Это критически важно для работы автоматической генерации новостей.

### 3. `context_processors.py`
Глобальные данные для шаблонов.
- `latest_news(request)`: Возвращает 3 последние новости и список категорий (с подсчетом кол-ва новостей в каждой). Это позволяет отображать блок "Последние новости" в футере или сайдбаре на любой странице сайта.

### 4. `feeds.py`
Генерация RSS-лент.
- `LatestNewsFeed(Feed)`: Создает XML-ленту последних 20 новостей, доступную по адресу `/news/feed/`.
    - `items()`: Возвращает последние 20 активных новостей.
    - `item_title`, `item_description`, `item_link`: Формируют стандартные элементы RSS-канала.

### 5. `forms.py`
Формы для админки.
- `NewsForm` и `NewsCategoryForm`: Подключают визуальный редактор **TinyMCE** для полей с контентом и описанием, делая редактирование удобным.

### 6. `models.py`
Структура данных.

**Классы:**
- `NewsCategory(ActiveModel, SEOModel, HeaderModel)`: Категория новостей. Наследует настройки шапки сайта, что позволяет каждой категории иметь свой уникальный "Header".
- `News(ActiveModel, SEOModel, TimestampModel)`: Дневная сводка новостей.
    - **НОВОЕ:** Поле `news_date` - дата, к которой относятся события (год, месяц, день).
    - **НОВОЕ:** Уникальность по `(category, news_date)` - одна новость на дату в категории.
    - **НОВОЕ:** Метод `get_events_count()` - возвращает количество событий за день.
    - `increment_views()`: Метод для потокобезопасного увеличения счетчика просмотров (использует `.update()`, не вызывая сигналы).
- **НОВОЕ:** `DailyEvent(TimestampModel)`: Отдельное событие в рамках дневной новости.
    - Поля: `event_type`, `title`, `description`, `image`, `order`, `related_object_id`, `related_object_type`.
    - Связь с новостью через `ForeignKey` с `related_name='events'`.
- `Comment`: Модель комментариев к новостям (пока базовая реализация).

### 7. `signals.py`
**Ключевой файл автоматизации.** Содержит логику "реакции" на события в других приложениях.

**Функции:**
- `transliterate()`: Вспомогательная функция для генерации slug из заголовков.
- `get_unique_slug(model_class, title)`: Генерирует уникальный URL, добавляя цифры если такой slug уже занят.
- **НОВОЕ:** `get_or_create_daily_news(category, event_date)`: Получает существующую или создает новую дневную новость для указанной даты и категории.
- **НОВОЕ:** `add_event_to_daily_news(news, event_type, title, description, ...)`: Добавляет событие к дневной новости с защитой от дублей.
- **НОВОЕ:** `update_news_content(news)`: Автоматически обновляет контент новости на основе всех её событий.

**Обработчик `auto_create_news_event` (ранее `auto_create_news`):**
Подписан на сигнал `post_save`. Срабатывает при сохранении моделей из других приложений:

1. **Portfolio (Портфолио)**:
    - Если создана новая работа → Добавляет событие "Добавлена новая работа..." к дневной новости.
    - Если обновлена → Добавляет событие "Обновлена информация...".
    - Автоматически создает/находит категорию новостей по имени категории портфолио.
    - **НОВОЕ:** События группируются по дате - все работы, добавленные в один день, попадают в одну новость.

2. **Review (Отзывы)**:
    - Только если статус отзыва стал `approved` (Одобрено).
    - Добавляет событие "Новый отзыв от..." к дневной новости.
    - Категория новостей: "Отзывы".

3. **Page (Страницы)**:
    - Если создана/обновлена страница.
    - Категория новостей: "Страницы".

**Важно:** Система автоматически группирует события по дате (день, месяц, год). Если в один день происходит несколько событий, они все добавляются к одной дневной новости, а не создают отдельные новости.

### 8. `views.py`
Логика отображения.

**Функции:**
- `get_latest_news()`: Кэшируемая функция (на 5 минут) для получения топа новостей.
- `news_list(request)`: Список всех новостей с пагинацией (9 штук на страницу).
- `news_by_category(request, category_slug)`: Фильтрация новостей по категории.
- `news_search(request)`: Поиск по заголовку, описанию и контенту (`Q` объекты для условий ИЛИ).
- `news_detail(request, slug)`: Страница одной новости. Увеличивает счетчик просмотров при открытии.

### 9. `urls.py`
Маршруты URL.
- `/` → Список новостей.
- `/search/` → Поиск.
- `/category/<slug>/` → Фильтр по категории.
- `/feed/` → RSS лента.
- `/<slug>/` → Детальная страница новости.

---

## Система группировки событий по датам

Подробное описание новой функциональности см. в [README_DAILY_NEWS.md](./README_DAILY_NEWS.md)

**Краткое описание:**
- Все события одного дня (год, месяц, день) группируются в одну дневную новость
- Каждое событие сохраняется как отдельный объект `DailyEvent`
- Контент новости автоматически генерируется на основе всех событий дня
- Защита от дублирования событий
- Удобное управление через админку с inline-редактором событий

