# Система группировки новостей по датам

## Описание

Реализована новая система управления новостями, которая автоматически группирует события по датам (день, месяц, год). Теперь при добавлении нового события (работа в портфолио, отзыв, страница и т.д.) система проверяет, существует ли уже новость для текущей даты в соответствующей категории:

- **Если новость существует** - событие добавляется к существующей дневной новости
- **Если новости нет** - создается новая дневная новость с этим событием

## Структура данных

### Модель `News` (Новость)
Представляет собой дневную сводку событий:
- `title` - заголовок новости (например, "События 06.01.2026 - Портфолио")
- `slug` - уникальный URL
- `category` - категория новостей
- `news_date` - дата, к которой относятся события (год, месяц, день)
- `image` - изображение новости (опционально)
- `content` - автоматически генерируемый контент на основе событий
- `views` - количество просмотров

**Уникальность**: Одна новость на дату в рамках категории (`unique_together = [['category', 'news_date']]`)

### Модель `DailyEvent` (Событие дня)
Представляет отдельное событие в рамках дневной новости:
- `news` - связь с дневной новостью
- `event_type` - тип события (добавление/обновление работы, отзыв, страница и т.д.)
- `title` - заголовок события
- `description` - описание события (HTML)
- `image` - изображение события (опционально)
- `order` - порядок отображения
- `related_object_id` и `related_object_type` - связь с исходным объектом
- `created_at` - время создания события

## Типы событий

Система поддерживает следующие типы событий:
- `portfolio_added` - Добавлена работа в портфолио
- `portfolio_updated` - Обновлена работа в портфолио
- `review_approved` - Одобрен отзыв
- `page_created` - Создана страница
- `page_updated` - Обновлена страница
- `service_added` - Добавлена услуга
- `service_updated` - Обновлена услуга
- `other` - Другое событие

## Как это работает

### 1. Автоматическое создание событий (signals.py)

При сохранении объектов (Portfolio, Review, Page) срабатывает сигнал `auto_create_news_event`, который:

1. Определяет текущую дату
2. Получает или создает категорию новостей
3. Вызывает `get_or_create_daily_news()` для получения/создания дневной новости
4. Вызывает `add_event_to_daily_news()` для добавления события

### 2. Получение или создание дневной новости

Функция `get_or_create_daily_news(category, event_date)`:
- Ищет существующую новость для указанной даты и категории
- Если находит - возвращает её
- Если не находит - создает новую с заголовком "События ДД.ММ.ГГГГ - Категория"

### 3. Добавление события к новости

Функция `add_event_to_daily_news(news, event_type, title, description, ...)`:
- Проверяет, не было ли уже добавлено такое событие (защита от дублей)
- Создает новое событие `DailyEvent`
- Вызывает `update_news_content()` для обновления контента новости

### 4. Обновление контента новости

Функция `update_news_content(news)`:
- Получает все события дневной новости
- Формирует HTML-контент с перечислением всех событий
- Обновляет поле `content` новости

## Пример работы

### Сценарий 1: Первое событие дня
1. Пользователь добавляет работу в портфолио в 10:00
2. Система создает новость "События 06.01.2026 - Портфолио"
3. Добавляет событие "Добавлена новая работа: Название работы"
4. Контент новости содержит одно событие

### Сценарий 2: Второе событие в тот же день
1. Пользователь добавляет еще одну работу в 14:00
2. Система находит существующую новость "События 06.01.2026 - Портфолио"
3. Добавляет к ней второе событие "Добавлена новая работа: Название работы 2"
4. Контент новости обновляется и теперь содержит два события

### Сценарий 3: Событие на следующий день
1. Пользователь добавляет работу 07.01.2026
2. Система создает новую новость "События 07.01.2026 - Портфолио"
3. Добавляет событие к новой новости

## Администрирование

### Админка новостей (NewsAdmin)
- Отображает дату новости (`news_date`)
- Показывает количество событий за день
- Позволяет редактировать события через inline-форму `DailyEventInline`
- Фильтрация по дате новости

### Админка событий (DailyEventAdmin)
- Управление отдельными событиями
- Фильтрация по типу события, категории новости, дате создания
- Просмотр связанных объектов

## Миграция данных

При обновлении системы выполняется миграция `0010`:
1. Добавляется поле `news_date` к существующим новостям
2. Значение `news_date` устанавливается из `created_at`
3. Если есть конфликты (несколько новостей с одной датой в категории), даты сдвигаются на +1 день
4. Добавляется unique constraint для `(category, news_date)`

## Преимущества новой системы

1. **Группировка событий** - все события дня собраны в одной новости
2. **Автоматическое обновление** - контент новости обновляется при добавлении событий
3. **Защита от дублей** - система не создает повторяющиеся события
4. **Гибкость** - легко добавить новые типы событий
5. **Удобство администрирования** - все события дня видны в одном месте
6. **Хронология** - события отображаются с указанием времени создания

## Дальнейшее развитие

Возможные улучшения:
- Шаблоны для отображения событий на фронтенде
- Группировка событий по типам внутри дневной новости
- Настройка автоматической генерации заголовков новостей
- Добавление изображений к дневным новостям на основе событий
- Email-уведомления о событиях дня
