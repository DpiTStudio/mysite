# Приложение Portfolio - Портфолио и услуги

## Описание

Приложение `portfolio` реализует систему портфолио и услуг. Оно позволяет управлять работами портфолио, категориями и заказами услуг. Работы портфолио могут быть отмечены как услуги с указанием цен.

## Основные возможности

- Управление категориями портфолио с SEO-настройками
- Создание работ портфолио с HTML-контентом
- Прайс-лист услуг
- Форма заказа услуг
- Управление заказами услуг через админку
- Фильтрация по категориям
- Пагинация списка работ
- Счетчик просмотров
- Контекстный процессор для отображения последних работ на всех страницах
- Поддержка цен: фиксированная цена или диапазон цен

---

## Структура файлов

### `models.py` - Модели данных

#### Класс `PortfolioCategory`

Модель категории портфолио. Наследуется от абстрактных моделей `ActiveModel`, `SEOModel`, `HeaderModel` из приложения `main`.

**Поля модели:**

- `name` (CharField, max_length=100) - Название категории
- `slug` (SlugField, unique=True) - URL-адрес категории (уникальный)
- `logo` (ImageField) - Логотип категории, загружается в `media/portfolio/categories/`
- `description` (TextField) - Описание категории
- `content` (HTMLField) - HTML-описание категории на странице (по умолчанию: `<p>Описание</p>`)
- `order` (IntegerField, default=0) - Порядок сортировки категорий

**Наследуемые поля от абстрактных моделей:**

От `ActiveModel`:
- `is_active` (BooleanField) - Активна ли категория

От `SEOModel`:
- `meta_title` - SEO заголовок
- `meta_keywords` - SEO ключевые слова
- `meta_description` - SEO описание

От `HeaderModel`:
- `header_image` - Изображение для шапки страницы категории
- `header_title` - Заголовок шапки
- `header_description` - Описание в шапке

**Методы:**

- `__str__()` - Возвращает название категории

**Meta-опции:**

- `verbose_name` = "Категория портфолио"
- `verbose_name_plural` = "Категории портфолио"
- `ordering` = ["order", "name"] - Сортировка сначала по порядку, затем по названию

---

#### Класс `Portfolio`

Модель работы портфолио или услуги.

**Поля модели:**

- `title` (CharField, max_length=200) - Заголовок работы/услуги
- `slug` (SlugField, unique=True) - URL-адрес (уникальный)
- `category` (ForeignKey) - Связь с категорией портфолио (каскадное удаление)
- `image` (ImageField) - Изображение работы, загружается в `media/portfolio/images/`
- `content` (HTMLField, default="<p>Контент сайта</p>") - HTML-содержимое работы
- `views` (IntegerField, default=0) - Счетчик просмотров

**Поля для услуг:**

- `price` (DecimalField, optional) - Цена (обычная, фиксированная)
- `min_price` (DecimalField, optional) - Минимальная цена (для диапазона)
- `max_price` (DecimalField, optional) - Максимальная цена (для диапазона)
- `is_service` (BooleanField, default=False) - Флаг: это услуга или работа портфолио

**Наследуемые поля:**

От `ActiveModel`:
- `is_active` - Активна ли работа

От `SEOModel`:
- `meta_title`, `meta_keywords`, `meta_description` - SEO поля

От `TimestampModel`:
- `created_at` - Дата создания записи
- `updated_at` - Дата последнего обновления

**Методы:**

- `__str__()` - Возвращает заголовок работы
- `increment_views()` - Увеличивает счетчик просмотров на 1
  - Использует `update()` для оптимизации (избегает вызова `save()` и сигналов)

**Meta-опции:**

- `verbose_name` = "Портфолио/Услуга"
- `verbose_name_plural` = "Портфолио/Услуги"
- `ordering` = ["-created_at"] - Сортировка по дате создания (новые сверху)

**Особенности:**
Модель объединяет функциональность портфолио и услуг. Поле `is_service` определяет, является ли запись работой портфолио или услугой. Для услуг можно указать цену (фиксированную или диапазон).

---

#### Класс `ServiceOrder`

Модель заказа услуги.

**Поля модели:**

- `service` (ForeignKey, limit_choices_to={'is_service': True}) - Связь с услугой (только услуги, не работы портфолио)
- `full_name` (CharField, max_length=255) - ФИО заказчика
- `email` (EmailField) - Email заказчика
- `phone` (CharField, max_length=20) - Телефон заказчика
- `message` (TextField, optional) - Сообщение/комментарий к заказу
- `status` (CharField, max_length=20) - Статус заказа
  - Выборы:
    - `"pending"` - Ожидает
    - `"processing"` - В обработке
    - `"completed"` - Завершено
    - `"cancelled"` - Отменено

**Наследуемые поля:**

От `TimestampModel`:
- `created_at` - Дата создания заказа
- `updated_at` - Дата последнего обновления

**Методы:**

- `__str__()` - Возвращает строку вида "Заказ [название услуги] от [ФИО]"

**Meta-опции:**

- `verbose_name` = "Заказ услуги"
- `verbose_name_plural` = "Заказы услуг"
- `ordering` = ["-created_at"] - Сортировка по дате (новые сверху)

---

### `views.py` - Представления (Views)

#### Функция `get_latest_portfolio()`

Вспомогательная функция для получения последних 3 активных работ портфолио (не услуг).

**Функциональность:**

1. Фильтрует только работы портфолио (`is_service=False`)
2. Фильтрует только активные работы
3. Использует `select_related("category")` для оптимизации запросов
4. Сортирует по дате создания (новые первыми)
5. Ограничивает до 3 записей

**Возвращает:**
- QuerySet из 3 объектов `Portfolio`

**Использование:**
Используется в представлениях для отображения последних работ в боковой панели или на главной странице.

---

#### Функция `portfolio_list(request)`

Отображает список всех работ портфолио с пагинацией.

**Функциональность:**

1. Получает queryset активных работ портфолио:
   - Фильтрует только работы (`is_service=False`)
   - Фильтрует только активные работы (`is_active=True`)
   - Использует `select_related("category")` для оптимизации
   - Сортирует по дате создания (новые первыми)

2. Получает список категорий:
   - Фильтрует активные категории
   - Добавляет аннотацию `portfolio_count` с количеством работ в каждой категории

3. Пагинация:
   - По 9 работ на страницу
   - Обрабатывает параметр `page` из GET-запроса
   - Обрабатывает исключения (неверный номер страницы, пустая страница)

4. Рендеринг шаблона:
   - Передает объект страницы с работами
   - Список категорий
   - Последние 3 работы (через функцию `get_latest_portfolio()`)

**Шаблон:** `portfolio/list.html`

**URL:** `/portfolio/`

---

#### Функция `price_list(request)`

Отображает прайс-лист услуг и форму заказа.

**Функциональность:**

1. Получает список услуг:
   - Фильтрует только услуги (`is_service=True`)
   - Фильтрует только активные услуги
   - Использует `select_related("category")` для оптимизации

2. Получает категории с услугами:
   - Фильтрует категории, в которых есть хотя бы одна услуга
   - Использует `distinct()` для исключения дублей

3. Обработка формы заказа:
   - При GET-запросе: создает пустую форму
   - При POST-запросе:
     - Получает ID услуги из POST-данных
     - Получает объект услуги
     - Валидирует форму
     - Сохраняет заказ с привязкой к услуге
     - Показывает сообщение об успехе
     - Перенаправляет на страницу прайс-листа
     - При ошибке: показывает сообщение об ошибке

4. Рендеринг шаблона:
   - Передает список услуг
   - Список категорий
   - Форму заказа

**Шаблон:** `portfolio/price_list.html`

**URL:** `/portfolio/prices/`

---

#### Функция `portfolio_by_category(request, category_slug)`

Отображает работы портфолио по конкретной категории с пагинацией.

**Параметры:**

- `category_slug` - URL-слаг категории из URL-маршрута

**Функциональность:**

1. Получает категорию по слагу:
   - Использует `get_object_or_404()` для безопасного получения
   - Проверяет, что категория активна

2. Фильтрует работы:
   - Только из указанной категории
   - Только работы портфолио (не услуги)
   - Только активные работы

3. Получает список всех категорий (для бокового меню)

4. Применяет пагинацию (9 работ на страницу)

5. Рендеринг:
   - Передает отфильтрованные работы
   - Текущую категорию
   - Список всех категорий
   - Последние работы

**Шаблон:** `portfolio/list.html`

**URL:** `/portfolio/category/<category_slug>/`

---

#### Функция `portfolio_detail(request, slug)`

Отображает детальную страницу работы портфолио или услуги.

**Параметры:**

- `slug` - URL-слаг работы/услуги

**Функциональность:**

1. Получает работу по слагу:
   - Использует `get_object_or_404()` для безопасного получения
   - Проверяет, что работа активна

2. Увеличивает счетчик просмотров:
   - Вызывает `portfolio.increment_views()`

3. Получает список категорий (для навигации)

4. Получает похожие работы:
   - Из той же категории
   - Того же типа (работа или услуга)
   - Исключает текущую работу
   - Ограничивает до 3 работ

5. Рендеринг шаблона:
   - Передает объект работы
   - Похожие работы
   - Последние работы
   - Список категорий

**Шаблон:** `portfolio/detail.html`

**URL:** `/portfolio/<slug>/`

---

### `admin.py` - Административный интерфейс

#### Класс `PortfolioCategoryAdmin`

Административный класс для управления категориями портфолио.

**Настройки отображения:**

- `form` = `PortfolioCategoryForm` - Использует кастомную форму с TinyMCE
- `list_display` - Колонки: название, активность, порядок
- `list_editable` - Редактируемые прямо в списке: порядок, активность
- `prepopulated_fields` - Автозаполнение slug из названия
- `list_filter` - Фильтр по активности
- `search_fields` - Поиск по названию

**Fieldsets:**

1. **Основная информация:**
   - Название, slug, логотип, описание, контент, порядок, активность

2. **Настройка шапки (Header):**
   - Изображение, заголовок, описание шапки

3. **SEO настройки:**
   - Мета-заголовок, ключевые слова (сворачиваемый раздел)

---

#### Класс `PortfolioAdmin`

Административный класс для управления работами портфолио и услугами.

**Настройки:**

- `form` = `PortfolioForm` - Кастомная форма с TinyMCE
- `list_display` - Колонки: заголовок, категория, цена, минимальная цена, максимальная цена, флаг услуги, активность, дата создания, просмотры
- `list_editable` - Редактируемые колонки: активность, цены, флаг услуги
- `prepopulated_fields` - Автозаполнение slug
- `list_filter` - Фильтры: тип (услуга/работа), категория, активность, дата создания
- `search_fields` - Поиск: заголовок, содержимое
- `date_hierarchy` = "created_at" - Иерархический фильтр по дате

**Fieldsets:**

1. **Основная информация:**
   - Заголовок, slug, категория, изображение, содержимое, цены, флаг услуги, просмотры

2. **SEO настройки:**
   - Мета-заголовок, ключевые слова, мета-описание (сворачиваемый)

3. **Дополнительно:**
   - Активность (сворачиваемый)

---

#### Класс `ServiceOrderAdmin`

Административный класс для управления заказами услуг.

**Настройки:**

- `list_display` - Колонки: услуга, ФИО, email, телефон, статус, дата создания
- `list_filter` - Фильтры: статус, дата создания, услуга
- `search_fields` - Поиск: ФИО, email, телефон, сообщение
- `list_editable` - Редактируемая колонка: статус
- `readonly_fields` - Только чтение: дата создания и обновления

**Fieldsets:**

1. **Информация о заказе:**
   - Услуга, статус

2. **Контактные данные:**
   - ФИО, email, телефон, сообщение

3. **Системная информация:**
   - Дата создания, дата обновления (сворачиваемый)

---

### `forms.py` - Формы

#### Класс `PortfolioCategoryForm`

Форма для редактирования категории портфолио.

**Особенности:**
- Использует TinyMCE виджет для поля `description`
- Все поля модели включены автоматически

---

#### Класс `PortfolioForm`

Форма для редактирования работы портфолио или услуги.

**Особенности:**
- Использует TinyMCE виджет для полей `content` и `meta_description`
- Все поля модели включены автоматически

---

#### Класс `ServiceOrderForm`

Форма для создания заказа услуги.

**Поля:**

- `full_name` - ФИО (TextInput с CSS классом `form-control`)
- `email` - Email (EmailInput с CSS классом)
- `phone` - Телефон (TextInput)
- `message` - Сообщение (Textarea с 4 строками)

**Особенности:**
- Все поля имеют плейсхолдеры
- Использует Bootstrap классы для стилизации

---

### `urls.py` - URL-маршруты

**Пространство имен:** `portfolio`

**Маршруты:**

1. `""` - Список работ портфолио (`views.portfolio_list`)
2. `"prices/"` - Прайс-лист услуг (`views.price_list`)
3. `"category/<category_slug>/"` - Работы по категории (`views.portfolio_by_category`)
4. `"<slug>/"` - Детальная страница работы/услуги (`views.portfolio_detail`)

---

### `context_processors.py` - Контекстные процессоры

#### Функция `latest_portfolio(request)`

Контекстный процессор, добавляющий последние работы портфолио во все шаблоны.

**Возвращает словарь:**

- `latest_portfolio` - Последние 3 активные работы портфолио (не услуги)

**Использование:**
Добавлен в `settings.py` в `TEMPLATES['OPTIONS']['context_processors']`, поэтому доступен во всех шаблонах автоматически.

---

## Использование

### Просмотр портфолио

1. Список всех работ: `/portfolio/`
2. Работы по категории: `/portfolio/category/<category_slug>/`
3. Детальная страница: `/portfolio/<slug>/`
4. Прайс-лист услуг: `/portfolio/prices/`

### Заказ услуги

1. Перейдите на страницу прайс-листа `/portfolio/prices/`
2. Найдите нужную услугу
3. Заполните форму заказа:
   - ФИО
   - Email
   - Телефон
   - Сообщение (необязательно)
4. Нажмите кнопку отправки
5. Заказ будет создан и доступен в админ-панели

### Администрирование

1. Войдите в админ-панель Django
2. Перейдите в раздел "Portfolio"
3. Управляйте категориями, работами и заказами услуг

---

## Зависимости

- Django
- django-tinymce (для HTML-редактора)
- Приложение `main` (абстрактные модели)

---

## Особенности

- Объединение портфолио и услуг в одной модели
- Поддержка разных типов цен (фиксированная, диапазон)
- Форма заказа услуг с валидацией
- Управление статусами заказов
- Оптимизированное увеличение счетчика просмотров
- Разделение работ портфолио и услуг через флаг `is_service`

---

## Интеграция с новостями

При создании или обновлении работ портфолио автоматически создаются события в системе новостей (через сигналы Django из приложения `news`). События группируются по датам.
