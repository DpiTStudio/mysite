{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% if site_settings %}{{ site_settings.site_title }}{% else %}DPIT-CMS{% endif %}{% endblock %}</title>
    
    <!-- Базовые мета-теги -->
    <meta name="description" content="{% block meta_description %}{% if site_settings %}{{ site_settings.meta_description }}{% else %}DPIT-CMS - Современная система управления контентом{% endif %}{% endblock %}">
    <meta name="keywords" content="{% block meta_keywords %}{% if site_settings %}{{ site_settings.meta_keywords }}{% endif %}{% endblock %}">
    <meta name="author" content="{% if site_settings %}{{ site_settings.site_title }}{% else %}DPIT-CMS{% endif %}">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="{% block og_type %}website{% endblock %}">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    <meta property="og:title" content="{% block og_title %}{% if site_settings %}{{ site_settings.site_title }}{% else %}DPIT-CMS{% endif %}{% endblock %}">
    <meta property="og:description" content="{% block og_description %}{% if site_settings %}{{ site_settings.meta_description }}{% else %}DPIT-CMS - Современная система управления контентом{% endif %}{% endblock %}">
    <meta property="og:image" content="{% block og_image %}{% if site_settings and site_settings.logo %}{{ request.scheme }}://{{ request.get_host }}{{ site_settings.logo.url }}{% else %}{{ request.scheme }}://{{ request.get_host }}{% static 'images/logo.png' %}{% endif %}{% endblock %}">
    <meta property="og:site_name" content="{% if site_settings %}{{ site_settings.site_title }}{% else %}DPIT-CMS{% endif %}">
    <meta property="og:locale" content="ru_RU">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="{{ request.build_absolute_uri }}">
    <meta name="twitter:title" content="{% block twitter_title %}{% if site_settings %}{{ site_settings.site_title }}{% else %}DPIT-CMS{% endif %}{% endblock %}">
    <meta name="twitter:description" content="{% block twitter_description %}{% if site_settings %}{{ site_settings.meta_description }}{% else %}DPIT-CMS - Современная система управления контентом{% endif %}{% endblock %}">
    <meta name="twitter:image" content="{% block twitter_image %}{% if site_settings and site_settings.logo %}{{ request.scheme }}://{{ request.get_host }}{{ site_settings.logo.url }}{% else %}{{ request.scheme }}://{{ request.get_host }}{% static 'images/logo.png' %}{% endif %}{% endblock %}">
    
    <!-- Фавикон -->
    <link rel="icon" href="{% static 'images/favicon.ico' %}" type="image/x-icon">
    <link rel="shortcut icon" href="{% static 'images/favicon.ico' %}" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'images/apple-touch-icon.png' %}">
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'images/favicon-32x32.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'images/favicon-16x16.png' %}">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link href="{% static 'css/root.css' %}" rel="stylesheet">
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
    <link href="{% static 'css/theme_seasons.css' %}" rel="stylesheet">
    
    <!-- Block for extra CSS -->
    {% block extra_css %}{% endblock %}
    
    <!-- Каноническая ссылка -->
    <link rel="canonical" href="{{ request.build_absolute_uri }}">

    <!-- Дополнительные мета-теги -->
    {% block meta %}{% endblock %}
    
    <!-- Структурированные данные (JSON-LD) -->
    {% block structured_data %}
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "{% block schema_type %}WebSite{% endblock %}",
        "name": "{% if site_settings %}{{ site_settings.site_title }}{% else %}DPIT-CMS{% endif %}",
        "description": "{% if site_settings %}{{ site_settings.meta_description }}{% else %}DPIT-CMS - Современная система управления контентом{% endif %}",
        "url": "{{ request.scheme }}://{{ request.get_host }}",
        {% if site_settings and site_settings.logo %}
        "logo": "{{ request.scheme }}://{{ request.get_host }}{{ site_settings.logo.url }}",
        {% endif %}
        "publisher": {
            "@type": "Organization",
            "name": "{% if site_settings %}{{ site_settings.site_title }}{% else %}DPIT-CMS{% endif %}"
        }
    }
    </script>
    {% endblock %}
</head>
<body class="{{ current_season }}">
    <!-- Preloader -->
    <div id="preloader" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--color-dark-bg); z-index: 99999; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s ease, visibility 0.5s ease;">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Загрузка...</span>
        </div>
    </div>

    <!-- Scroll Progress Bar -->
    <div id="scroll-progress" style="position: fixed; top: 0; left: 0; width: 0%; height: 3px; background: var(--gradient-premium); z-index: 100000; transition: width 0.1s ease;"></div>

    <!-- Шапка + меню -->
    <section class="bl-nav">
        {% include 'header.html' %}
    </section>

    <!-- Шапка + лого (Герой-секция) -->
    <section class="bl-logo container-fluid p-0">
        {% include 'hero.html' %}
    </section>

    <!-- Содержимое -->
    <main class="container-fluid py-0 px-lg-5">
        <div class="container-fluid">
            {% if request.path != '/' %}
            <!-- Секция категорий (только не на главной) -->
            <div class="row pt-2 mb-4">
                <div class="col-12">
                    {% include 'category-bl.html' %}
                </div>
            </div>
            {% endif %}
            
            <div class="row g-4">
                <!-- Основной контент -->
                <div class="col-12 col-lg-9">
                    <div class="content-wrapper animate-up animate-active">
                        {% if '/news/' in request.path %}
                        <div class="section-title-wrapper mb-4 animate-fade">
                            <h1 class="h2 text-white fw-bold border-start border-4 border-primary ps-3">
                                Новости и Статьи
                            </h1>
                        </div>
                        {% endif %}
                        {% if messages %}
                            {% for message in messages %}
                                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                        
                        <div class="main-content-area">
                            {% block content %}
                            {% endblock %}
                        </div>
                    </div>
                </div>

                <!-- Боковая панель -->
                <aside class="col-12 col-lg-3">
                    <div class="sidebar-wrapper sticky-lg-top" style="top: 130px; z-index: 10;">
                        {% include 'includes/bl_news_sbar.html' %}
                        {% include 'includes/bl_portfolio_sbar.html' %}
                        {% include 'includes/bl_reviews_sbar.html' %}
                    </div>
                </aside>
            </div>
        </div>
    </main>

    <!-- Модальное окно поиска (Full Screen) -->
    <div class="modal fade glass-search-modal" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content bg-transparent border-0">
                <div class="modal-header border-0 pb-0">
                    <button type="button" class="btn-close btn-close-white ms-auto p-4" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                </div>
                <div class="modal-body d-flex flex-column align-items-center mb-5 mt-3">
                    <form class="w-100 max-w-700 animate-up animate-active" action="{% url 'main:search' %}" method="get">
                        <div class="input-group input-group-lg search-input-group">
                            <span class="input-group-text bg-transparent border-end-0 border-bottom text-white"><i class="bi bi-search fs-3"></i></span>
                            <input type="search" name="q" class="form-control bg-transparent border-start-0 border-end-0 border-bottom text-white fs-2 text-center search-input-huge" 
                                placeholder="Что вы ищете?" 
                                value="{{ request.GET.q|default:'' }}" 
                                autofocus
                                hx-get="{% url 'main:search' %}"
                                hx-target="#search-results"
                                hx-trigger="keyup changed delay:500ms">
                            <button class="btn btn-primary px-4 ms-2 rounded-pill d-none d-md-block" type="submit">Найти</button>
                        </div>
                    </form>
                    
                    <div id="search-results" class="w-100 max-w-700 mt-4 h-100" style="max-width: 900px;">
                        <!-- HTMX injects search results here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Offcanvas для Корзины -->
    <div class="offcanvas offcanvas-end glass-offcanvas" tabindex="-1" id="cartOffcanvas" aria-labelledby="cartOffcanvasLabel">
        <div class="offcanvas-header border-bottom border-secondary border-opacity-25 glass-offcanvas-header">
            <h5 class="offcanvas-title text-white fw-bold d-flex align-items-center gap-2" id="cartOffcanvasLabel">
                <i class="bi bi-cart3 text-primary fs-4"></i> Ваша корзина
                <span class="badge bg-danger rounded-pill" id="cart-offcanvas-count">{{ cart|length }}</span>
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Закрыть"></button>
        </div>
        <div class="offcanvas-body" id="cart-offcanvas-body">
            <!-- Сюда будет грузиться контент через HTMX или AJAX -->
            <div class="text-center text-muted my-5" hx-get="{% url 'cart:cart_detail' %}?partial=true" hx-trigger="load, cartUpdated from:body" hx-target="this">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Загрузка...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Футер -->
    {% include 'footer.html' %}
    
    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
    <script src="https://unpkg.com/htmx.org@1.9.10" defer></script>
    <script src="{% static 'js/script.js' %}" defer></script>
    
    <!-- Block for extra JavaScript -->
    {% block extra_js %}{% endblock %}
</body>
</html>