# Приложение Tickets - Система тикетов (поддержки)

## Описание

Приложение `tickets` реализует систему тикетов для технической поддержки пользователей. Позволяет пользователям создавать тикеты с вопросами или проблемами, обмениваться сообщениями с администраторами и отслеживать статус решения тикетов.

## Основные возможности

- Создание тикетов пользователями
- Обмен сообщениями в рамках тикета
- Управление статусами тикетов (Открыт, В работе, Решен, Закрыт)
- Установка приоритетов (Низкий, Средний, Высокий, Срочный)
- Фильтрация тикетов по статусу
- Пагинация списка тикетов
- Разделение доступа: пользователи видят только свои тикеты, сотрудники - все
- Возможность закрытия тикетов
- Защита от спама через капчу при создании тикета
- Внутренние сообщения для сотрудников (не видны пользователям)

---

## Структура файлов

### `models.py` - Модели данных

#### Класс `TicketStatus`

Перечисление статусов тикета (TextChoices).

**Статусы:**

- `OPEN = "open"` - Открыт (по умолчанию)
- `IN_PROGRESS = "in_progress"` - В работе
- `RESOLVED = "resolved"` - Решен
- `CLOSED = "closed"` - Закрыт

---

#### Класс `TicketPriority`

Перечисление приоритетов тикета (TextChoices).

**Приоритеты:**

- `LOW = "low"` - Низкий
- `MEDIUM = "medium"` - Средний (по умолчанию)
- `HIGH = "high"` - Высокий
- `URGENT = "urgent"` - Срочный

---

#### Класс `Ticket`

Модель тикета (обращения в поддержку).

**Поля модели:**

- `user` (ForeignKey, related_name="tickets") - Связь с пользователем (каскадное удаление)
- `subject` (CharField, max_length=200) - Тема тикета
- `description` (TextField) - Описание проблемы/вопроса
- `status` (CharField, max_length=20) - Статус тикета (из `TicketStatus`)
- `priority` (CharField, max_length=20) - Приоритет тикета (из `TicketPriority`)
- `closed_at` (DateTimeField, optional) - Дата и время закрытия тикета

**Наследуемые поля:**

От `TimestampModel` (из приложения `main`):
- `created_at` - Дата создания тикета
- `updated_at` - Дата последнего обновления тикета

**Методы:**

- `__str__()` - Возвращает строку вида "Тема (статус)"
- `get_status_display()` - Возвращает читаемое название статуса (встроенный метод Django)

**Meta-опции:**

- `verbose_name` = "Тикет"
- `verbose_name_plural` = "Тикеты"
- `ordering` = ["-created_at"] - Сортировка по дате создания (новые сверху)

**Связанные объекты:**

- `messages` - Сообщения тикета (связь через `TicketMessage`, related_name)

---

#### Класс `TicketMessage`

Модель сообщения в тикете.

**Поля модели:**

- `ticket` (ForeignKey, related_name="messages") - Связь с тикетом (каскадное удаление)
- `user` (ForeignKey) - Автор сообщения
- `message` (TextField) - Текст сообщения
- `is_internal` (BooleanField, default=False) - Флаг внутреннего сообщения (только для сотрудников)

**Наследуемые поля:**

От `TimestampModel`:
- `created_at` - Дата создания сообщения
- `updated_at` - Дата последнего обновления сообщения

**Методы:**

- `__str__()` - Возвращает строку вида "Сообщение в тикете #[ID тикета]"

**Meta-опции:**

- `verbose_name` = "Сообщение тикета"
- `verbose_name_plural` = "Сообщения тикетов"
- `ordering` = ["created_at"] - Сортировка по дате создания (старые первыми)

**Особенности:**
- Внутренние сообщения (`is_internal=True`) видны только сотрудникам
- Сообщения сортируются в хронологическом порядке

---

### `views.py` - Представления (Views)

#### Функция `ticket_list(request)`

Отображает список тикетов пользователя (или все тикеты для сотрудников).

**Декоратор:**
- `@login_required` - Требует авторизации пользователя

**Функциональность:**

1. Проверяет статус пользователя:
   - Если пользователь - сотрудник (`is_staff`): показывает все тикеты
   - Иначе: показывает только тикеты текущего пользователя

2. Фильтрация по статусу:
   - Получает параметр `status` из GET-запроса
   - При наличии параметра фильтрует тикеты по статусу

3. Пагинация:
   - По 10 тикетов на страницу
   - Обрабатывает параметр `page` из GET-запроса

4. Рендеринг шаблона:
   - Передает объект страницы с тикетами
   - Список доступных статусов (для фильтрации)
   - Текущий выбранный статус

**Шаблон:** `tickets/list.html`

**URL:** `/tickets/`

---

#### Функция `ticket_create(request)`

Обрабатывает создание нового тикета.

**Декоратор:**
- `@login_required` - Требует авторизации пользователя

**Функциональность:**

1. **Обработка POST-запроса:**
   - Создает форму `TicketForm` с данными из POST
   - Валидирует форму (включая капчу)
   - При успехе:
     - Создает объект тикета, но не сохраняет (`commit=False`)
     - Привязывает тикет к текущему пользователю
     - Сохраняет тикет в базу данных
     - Показывает сообщение об успехе
     - Перенаправляет на страницу созданного тикета

2. **Обработка GET-запроса:**
   - Создает пустую форму
   - Рендерит шаблон с формой

**Шаблон:** `tickets/create.html`

**URL:** `/tickets/create/`

**Особенности:**
- Форма включает капчу для защиты от спама
- Пользователь автоматически привязывается к тикету

---

#### Функция `ticket_detail(request, ticket_id)`

Отображает детальную страницу тикета с сообщениями и возможностью добавления новых сообщений.

**Декоратор:**
- `@login_required` - Требует авторизации пользователя

**Параметры:**

- `ticket_id` - ID тикета из URL-маршрута

**Функциональность:**

1. Проверяет права доступа:
   - Если пользователь - сотрудник: получает тикет по ID (любой)
   - Иначе: получает тикет по ID и проверяет, что он принадлежит текущему пользователю
   - Использует `get_object_or_404()` для безопасного получения

2. **Обработка POST-запроса (добавление сообщения):**
   - Создает форму `TicketMessageForm` с данными из POST
   - Валидирует форму
   - При успехе:
     - Создает объект сообщения, но не сохраняет (`commit=False`)
     - Привязывает сообщение к тикету и текущему пользователю
     - Сохраняет сообщение
     - Если тикет был закрыт, меняет его статус на "Открыт"
     - Показывает сообщение об успехе
     - Перенаправляет на страницу тикета (для обновления списка сообщений)

3. **Обработка GET-запроса:**
   - Создает пустую форму для нового сообщения
   - Получает все сообщения тикета (через связь `messages`)
   - Рендерит шаблон с тикетом, сообщениями и формой

**Шаблон:** `tickets/detail.html`

**URL:** `/tickets/<ticket_id>/`

**Особенности:**
- При добавлении сообщения к закрытому тикету, он автоматически открывается
- Внутренние сообщения должны быть скрыты от обычных пользователей в шаблоне

---

#### Функция `ticket_close(request, ticket_id)`

Закрывает тикет (меняет статус на "Закрыт").

**Декоратор:**
- `@login_required` - Требует авторизации пользователя

**Параметры:**

- `ticket_id` - ID тикета из URL-маршрута

**Функциональность:**

1. Проверяет права доступа (аналогично `ticket_detail`)

2. Закрывает тикет:
   - Проверяет, что тикет еще не закрыт
   - Меняет статус на `TicketStatus.CLOSED`
   - Устанавливает `closed_at` на текущее время
   - Сохраняет изменения
   - Показывает сообщение об успехе

3. Перенаправляет на страницу тикета

**URL:** `/tickets/<ticket_id>/close/`

**Особенности:**
- Пользователи могут закрывать только свои тикеты
- Сотрудники могут закрывать любые тикеты

---

### `forms.py` - Формы

#### Класс `TicketForm`

Форма для создания тикета с капчей.

**Поля:**

- `captcha` - Поле капчи (CaptchaField) - защита от спама
- `subject` - Тема тикета (TextInput с CSS классом и плейсхолдером)
- `description` - Описание проблемы (Textarea с 5 строками)
- `priority` - Приоритет тикета (Select с выбором из `TicketPriority`)

**Метки полей:**
- Тема, Описание, Приоритет

**Особенности:**
- Использует `django-captcha` для защиты от спама
- Все поля имеют CSS классы Bootstrap
- Плейсхолдеры для удобства пользователя

---

#### Класс `TicketMessageForm`

Форма для добавления сообщения в тикет.

**Поля:**

- `message` - Текст сообщения (Textarea с 4 строками)

**Метка поля:**
- Сообщение

**Особенности:**
- Простая форма с одним полем
- CSS классы Bootstrap
- Плейсхолдер для удобства

---

### `admin.py` - Административный интерфейс

Стандартная регистрация моделей `Ticket` и `TicketMessage` в админ-панели Django.

**Рекомендуется настроить:**
- Фильтры по статусу, приоритету, пользователю
- Поиск по теме, описанию
- Сортировка по дате создания
- Inline для сообщений тикета

---

### `urls.py` - URL-маршруты

**Пространство имен:** `tickets`

**Маршруты:**

1. `""` - Список тикетов (`views.ticket_list`)
2. `"create/"` - Создание нового тикета (`views.ticket_create`)
3. `"<ticket_id>/"` - Детальная страница тикета (`views.ticket_detail`)
4. `"<ticket_id>/close/"` - Закрытие тикета (`views.ticket_close`)

---

### `apps.py` - Конфигурация приложения

Стандартная конфигурация Django приложения без дополнительных настроек.

---

## Использование

### Создание тикета

1. Войдите в систему (требуется авторизация)
2. Перейдите на страницу `/tickets/create/`
3. Заполните форму:
   - Тема тикета
   - Описание проблемы/вопроса
   - Приоритет (Низкий, Средний, Высокий, Срочный)
   - Решите капчу
4. Нажмите кнопку отправки
5. Тикет будет создан со статусом "Открыт"

### Просмотр тикетов

1. Перейдите на страницу `/tickets/`
2. Вы увидите список ваших тикетов (или все тикеты, если вы сотрудник)
3. Можете фильтровать по статусу через параметр `?status=open`
4. Используйте пагинацию для навигации по списку

### Просмотр тикета и обмен сообщениями

1. Откройте тикет из списка
2. Вы увидите:
   - Информацию о тикете (тема, описание, статус, приоритет)
   - Все сообщения в тикете (в хронологическом порядке)
   - Форму для добавления нового сообщения
3. Добавьте сообщение в форму и отправьте
4. Сообщение появится в списке сообщений тикета

### Закрытие тикета

1. Откройте тикет
2. Нажмите кнопку "Закрыть тикет" или перейдите на `/tickets/<ticket_id>/close/`
3. Статус тикета изменится на "Закрыт"
4. При добавлении нового сообщения закрытый тикет автоматически откроется

### Работа сотрудников

Сотрудники (пользователи с `is_staff=True`) имеют расширенные права:
- Видят все тикеты (не только свои)
- Могут закрывать любые тикеты
- Могут создавать внутренние сообщения (`is_internal=True`), которые видны только сотрудникам

---

## Зависимости

- Django
- django-captcha - Для защиты от спама при создании тикета
- Приложение `main` (абстрактная модель `TimestampModel`)
- Приложение `accounts` (модель `User`)

---

## Безопасность

- Доступ к тикетам только для авторизованных пользователей
- Пользователи видят только свои тикеты (кроме сотрудников)
- Защита от спама через капчу при создании тикета
- Внутренние сообщения скрыты от обычных пользователей

---

## Особенности реализации

### Разделение доступа

Функции представлений проверяют статус пользователя (`is_staff`) для определения прав доступа. Это позволяет сотрудникам видеть все тикеты, а обычным пользователям - только свои.

### Автоматическое открытие закрытого тикета

При добавлении сообщения к закрытому тикету система автоматически меняет его статус на "Открыт". Это позволяет пользователям продолжать общение, если проблема не была полностью решена.

### Внутренние сообщения

Поле `is_internal` в модели `TicketMessage` позволяет сотрудникам оставлять служебные заметки, которые не видны пользователям. Это полезно для координации работы поддержки.

---

## Рекомендации по улучшению

Возможные дополнения:
- Email-уведомления о новых сообщениях
- Прикрепление файлов к тикетам и сообщениям
- Категории тикетов
- История изменений статуса
- Передача тикета между сотрудниками
- Шаблоны ответов для сотрудников
- Статистика по тикетам (время решения, количество сообщений)
- Автоматическое закрытие неактивных тикетов
- Система рейтингов и оценок работы поддержки

---

## Шаблоны

Приложение использует следующие шаблоны:

- `tickets/list.html` - Список тикетов
- `tickets/create.html` - Форма создания тикета
- `tickets/detail.html` - Детальная страница тикета с сообщениями

Эти шаблоны должны быть созданы в директории `templates/tickets/`.

---

## Примеры использования

### Создание тикета программно

```python
from tickets.models import Ticket, TicketStatus, TicketPriority
from accounts.models import User

user = User.objects.get(username='testuser')
ticket = Ticket.objects.create(
    user=user,
    subject='Проблема с авторизацией',
    description='Не могу войти в систему',
    status=TicketStatus.OPEN,
    priority=TicketPriority.MEDIUM
)
```

### Добавление сообщения

```python
from tickets.models import TicketMessage

message = TicketMessage.objects.create(
    ticket=ticket,
    user=user,
    message='Проблема решена, попробуйте снова',
    is_internal=False
)
```

### Фильтрация тикетов

```python
# Все открытые тикеты
open_tickets = Ticket.objects.filter(status=TicketStatus.OPEN)

# Тикеты пользователя с высоким приоритетом
user_tickets = Ticket.objects.filter(
    user=user,
    priority=TicketPriority.HIGH
)
```
